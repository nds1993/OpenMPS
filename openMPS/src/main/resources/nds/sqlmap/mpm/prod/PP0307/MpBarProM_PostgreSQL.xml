<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="PP0307MpBarProM">
	
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="PP0307mpBarProMSerarchVO" type="nds.mpm.prod.PP0504.vo.MpBarProMVO"/>
	
	<sql id="selectWhere_fragment">
		  FROM (SELECT work_date, pro_code, san_qty AS plan_qty, 0 AS qty, 0 AS weig
		          FROM openmps.mp_plan_cm_d a
		         WHERE a.corp_code = #corpCode#
		           AND a.work_date BETWEEN #strtDate# AND #lastDate#
		           AND a.dele_yn = 'N'
		           AND a.san_qty > 0
		           AND a.plant_code = #plantCode#
		        UNION ALL
		        SELECT work_date, pro_code, work_qty AS plan_qty, 0 AS qty, 0 AS weig
		          FROM openmps.mp_plan_pm_m a
		         WHERE a.corp_code = #corpCode#
		           AND a.work_date BETWEEN #strtDate# AND #lastDate#
		           AND a.dele_yn = 'N'
		           AND a.plant_code = #plantCode#
		        UNION ALL
		        SELECT pro_date, pro_code, 0, 1 AS qty, a.box_weig AS weig
		          FROM openmps.mp_bar_pro_m a
		         WHERE a.corp_code = #corpCode#
		           AND a.pro_date BETWEEN #strtDate# AND #lastDate#
		           AND a.prdt_type IN ('1', '2')           
		           AND a.dele_yn = 'N'
		           AND a.plant_code = #plantCode#
		        UNION ALL
		        SELECT a.work_date, pro_code, 0, 1 AS qty, b.pro_weig AS weig
		          FROM openmps.mp_auto_total_m a, openmps.mp_item_master_m b
		         WHERE a.corp_code = #corpCode#
		           AND a.work_date BETWEEN #strtDate# AND #lastDate#
		           AND a.dele_yn = 'N'
		           AND a.corp_code = b.corp_code
		           AND a.pro_name = b.pro_name
		           AND a.plant_code = #plantCode#) a,
		       openmps.mp_item_master_m b
		  LEFT JOIN tm_codexd c ON b.corp_code = c.corp_code
		                       AND b.large_code = c.code_id
		                       AND c.group_code = 'MP006'
		 WHERE a.pro_code = b.pro_code
		   AND b.corp_code = #corpCode#
	</sql>
	<select id="PP0307MpBarProMDAO.selectMpBarProMList_D" parameterClass="PP0307mpBarProMSerarchVO" resultClass="egovMap">
				SELECT work_date,       
		       c.code_name AS lcode,
		       a.pro_code,
		       MAX(b.pro_name) AS pro_name,
		       SUM(plan_qty) AS plan_qty,
		       MAX(b.pro_ukind) AS uom,
		       SUM(qty) AS qty,       
		       SUM(weig) AS weig,
		       SUM(plan_qty) - SUM(qty) AS diff_qty
		<include refid="selectWhere_fragment"/>
	 	GROUP BY work_date, c.code_name, a.pro_code
	 	order by work_date, c.code_name, a.pro_code
	</select>	
	<select id="PP0307MpBarProMDAO.selectMpBarProMListTotCnt_S" parameterClass="PP0307mpBarProMSerarchVO" resultClass="int">
		select count(*)
		FROM	( 		SELECT work_date,       
		       c.code_name AS lcode,
		       a.pro_code,
		       MAX(b.pro_name) AS pro_name,
		       SUM(plan_qty) AS plan_qty,
		       MAX(b.pro_ukind) AS uom,
		       SUM(qty) AS qty,       
		       SUM(weig) AS weig,
		       SUM(plan_qty) - SUM(qty) AS diff_qty
		
		<include refid="selectWhere_fragment"/>
		
		GROUP BY work_date, c.code_name, a.pro_code
		) AS DUMMY_A
	</select>

	<select id="PP0307MpBarProMDAO.selectPopMpBarProMList_D" parameterClass="PP0307mpBarProMSerarchVO" resultClass="egovMap">
		SELECT bar_code, a.bunch_no, a.box_weig, to_char(a.cr_date,'hh24:mi:ss') as cr_date
		  FROM openmps.mp_bar_pro_m a
		 WHERE a.corp_code = #corpCode#
		   AND a.pro_date BETWEEN #proDate# AND #proDate#
		   AND a.dele_yn = 'N'
		   AND a.pro_code = #proCode#
		   AND a.prdt_type IN ('1', '2')
		   AND a.plant_code = #plantCode#
		UNION ALL
		SELECT a.print_code, a.bunch_no, b.pro_weig, to_char(a.cr_date,'hh24:mi:ss') as cr_date
		  FROM openmps.mp_auto_total_m a, openmps.mp_item_master_m b
		 WHERE a.corp_code = #corpCode#
		   AND a.work_date BETWEEN #proDate# AND #proDate#
		   AND a.dele_yn = 'N'
		   AND b.pro_code = #proCode#
		   AND a.corp_code = b.corp_code
		   AND a.pro_name = b.pro_name
		   AND a.plant_code = #plantCode#
		 ORDER BY 1   
	</select>
</sqlMap>
