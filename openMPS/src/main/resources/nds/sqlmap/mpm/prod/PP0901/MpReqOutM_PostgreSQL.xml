<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="MpReqOutM">
	
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="mpReqOutMSerarchVO" type="nds.mpm.prod.PP0901.vo.MpReqOutMVO"/>
	
	<resultMap id="mpReqOutM" class="nds.mpm.prod.PP0901.vo.MpReqOutMVO">
		<result property="corpCode" column="corp_code" columnIndex="1"/>
		<result property="plantCode" column="plant_code" columnIndex="2"/>
		<result property="workDate" column="work_date" columnIndex="3"/>
		<result property="mtrlCode" column="mtrl_code" columnIndex="4"/>
		<result property="usedQty" column="used_qty" columnIndex="5"/>
		<result property="unit" column="unit" columnIndex="6"/>
		<result property="oderno" column="oderno" columnIndex="7"/>
		<result property="odersn" column="odersn" columnIndex="8"/>
		<result property="dc" column="dc" columnIndex="9"/>
		<result property="outStatus" column="out_status" columnIndex="10"/>
		<result property="errorMsg" column="error_msg" columnIndex="11"/>
		<result property="mdUser" column="md_user" columnIndex="12"/>
		<result property="mdDate" column="md_date" columnIndex="13"/>
		<result property="crUser" column="cr_user" columnIndex="14"/>
		<result property="crDate" column="cr_date" columnIndex="15"/>
	</resultMap>
	
	<insert id="mpReqOutMDAO.insertMpReqOutM">
		<selectKey keyProperty="mtrlCode" resultClass="string">
		    select #mtrlCode#
		</selectKey>
		<![CDATA[
			INSERT INTO openmps.mp_req_out_m 
				( corp_code
				  , plant_code
				  , work_date
				  , mtrl_code
				  , used_qty
				  , unit
				  , oderno
				  , odersn
				  , dc
				  , out_status
				  , error_msg
				  , cr_user
				  , cr_date )
			VALUES ( #corpCode#
				  , #plantCode#
				  , #workDate#
				  , #mtrlCode#
				  , #usedQty#
				  , #unit#
				  , #oderno#
				  , #odersn#
				  , #dc#
				  , #outStatus#
				  , #errorMsg#
				  , #crUser#
				  , now() )
			ON CONFLICT (corp_code, plant_code, work_date, mtrl_code)
    		DO UPDATE SET
    			 mtrl_code=#mtrlCode#
				, used_qty=#usedQty#
				, unit=#unit#
				, oderno=#oderno#
				, odersn=#odersn#
				, dc=#dc#
				, out_status=#outStatus#
				, error_msg=#errorMsg#
				, md_user=#mdUser#
				, md_date=now()
		]]>
	</insert>
	
	<update id="mpReqOutMDAO.updateMpReqOutM">
		<![CDATA[
			UPDATE openmps.mp_req_out_m
			SET  mtrl_code=#mtrlCode#
				, used_qty=#usedQty#
				, unit=#unit#
				, oderno=#oderno#
				, odersn=#odersn#
				, dc=#dc#
				, out_status=#outStatus#
				, error_msg=#errorMsg#
				, md_user=#mdUser#
				, md_date=now()
						WHERE corp_code=#corpCode#
								AND plant_code=#plantCode#
								AND work_date=#workDate#
								AND mtrl_code=#mtrlCode#
				]]>
	</update>
	
	<delete id="mpReqOutMDAO.deleteMpReqOutM">
		<![CDATA[
			DELETE FROM openmps.mp_req_out_m 
						WHERE corp_code=#corpCode#
								AND plant_code=#plantCode#
								AND work_date=#workDate#
								AND mtrl_code=#mtrlCode#
				]]>
	</delete>
	
	<select id="mpReqOutMDAO.selectMpReqOutM_S" resultMap="mpReqOutM">
		<![CDATA[
			SELECT
				corp_code
				, plant_code
				, work_date
				, mtrl_code
				, used_qty
				, unit
				, oderno
				, odersn
				, dc
				, out_status
				, error_msg
				, md_user
				, md_date
				, cr_user
				, cr_date
			FROM openmps.mp_req_out_m
						WHERE corp_code=#corpCode#
								AND plant_code=#plantCode#
								AND work_date=#workDate#
								AND mtrl_code=#mtrlCode#
				]]>
	</select>
	<sql id="selectWhere_fragment">
	  	from openmps.mp_req_out_m a
		<dynamic> 
		</dynamic>
	</sql>
	<select id="mpReqOutMDAO.selectMpReqOutMList_D" parameterClass="mpReqOutMSerarchVO" resultClass="egovMap">
		SELECT
				corp_code
				, plant_code
				, work_date
				, mtrl_code
				, used_qty
				, unit
				, oderno
				, odersn
				, dc
				, out_status
				, error_msg
				, md_user
				, md_date
				, cr_user
				, cr_date
		<include refid="selectWhere_fragment"/>
	</select>	
	<select id="mpReqOutMDAO.selectMpReqOutMListTotCnt_S" parameterClass="mpReqOutMSerarchVO" resultClass="int">
		select count(*)
		<include refid="selectWhere_fragment"/>
	</select>
	
	<select id="mpReqOutMDAO.selectBomCurDayWorkList" parameterClass="mpReqOutMSerarchVO" resultClass="egovMap">
		SELECT a.corp_code,
		       a.plant_code,
		       a.pro_date as work_date,
		       c.pro_code as mtrl_code,
		       SUM(a.qty * c.qty) AS used_qty,
		       c.pro_unit as unit
		  FROM (SELECT a.corp_code, a.plant_code, a.pro_date, a.pro_code, SUM(qty) AS qty
		          FROM (SELECT a.corp_code, a.plant_code, a.pro_date, a.pro_code, 1 AS qty
		                  FROM openmps.mp_bar_pro_m a
		                 WHERE a.corp_code = '1001'
		                 	<isEqual property="searchCondition" compareValue="test">
		                 	AND a.pro_date = #workDate#
		                 	</isEqual>
		                 	<isNotEqual property="searchCondition" compareValue="test">
		                   AND a.pro_date = to_char(now(), 'YYYYMMDD')
		                  	</isNotEqual>
		                   AND a.dele_yn = 'N'
		                   AND a.prdt_type IN ('1', '2') 
		                
		                UNION ALL
		                SELECT a.corp_code, a.plant_code, a.work_date, b.pro_code, 1 AS qty
		                  FROM openmps.mp_auto_total_m a, openmps.mp_item_master_m b
		                 WHERE a.corp_code = '1001'
		                   <isEqual property="searchCondition" compareValue="test">
		                 	AND a.work_date = #workDate#
		                 	</isEqual>
		                 	<isNotEqual property="searchCondition" compareValue="test">
		                   AND a.work_date = to_char(now(), 'YYYYMMDD')
		                  	</isNotEqual>
		                   AND a.dele_yn = 'N'
		                   AND a.corp_code = b.corp_code
		                   AND a.pro_name = b.pro_name) AS a
		         GROUP BY a.corp_code, a.plant_code, a.pro_date, a.pro_code) a,
		       openmps.mp_bom_h b,
		       openmps.mp_bom_d c
		 WHERE a.corp_code = b.corp_code
		   AND a.plant_code = b.plant_code
		   AND a.pro_code = b.pro_code
		   AND b.use_yn = 'Y'
		   AND b.dele_yn = 'N'
		   
		   AND b.corp_code = c.corp_code
		   AND b.plant_code = c.plant_code
		   AND b.bom_code = c.bom_code
		   AND b.bom_ver = c.bom_ver
		   AND c.dele_yn = 'N'
		 GROUP BY a.corp_code, a.plant_code, a.pro_date, c.pro_code, c.pro_unit
		 <isEqual property="searchCondition" compareValue="test">
		 <!-- limit 10 -->
		 </isEqual>
	</select>
	<select id="mpReqOutMDAO.callWMSSetMtrlOder" resultClass="egovMap">
		select result_cdoe , recult_msg from openmps."set_mtrl_oder"(#workDate#,#plantCode#)
	</select>
</sqlMap>
