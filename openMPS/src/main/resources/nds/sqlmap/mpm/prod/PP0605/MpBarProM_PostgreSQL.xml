<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="PP0605MpBarProM">
	
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="PP0605mpBarProMSerarchVO" type="nds.mpm.prod.PP0504.vo.MpBarProMVO"/>
	
	<select id="PP0605mpBarProMDAO.selectMpBarProMList_H" parameterClass="PP0605mpBarProMSerarchVO" resultClass="egovMap">
		SELECT SUM(cur_dusu) AS san_dosu,
		       SUM(cur_doche) AS san_dosu_am,
		       SUM(cur_doche) / SUM(cur_dusu) * 100 AS san_dosu_rate,
		       SUM(sum_dusu) AS sum_dusu,
		       SUM(sum_doche) AS sum_dusu_am,
		       SUM(sum_doche) / SUM(sum_dusu) * 100 AS sum_dusu_rate
		  FROM (SELECT CASE
		                  WHEN work_date = #strtDate# THEN
		                   t.suyul_dusu
		                END AS cur_dusu,
		               CASE
		                  WHEN work_date = #strtDate# THEN
		                   CASE #searchKeyword# /*원료구분*/
		                  WHEN '1' THEN t.doche_qty1 /*암퇘지*/
		                  WHEN '2' THEN t.doche_qty3 /*더느림*/
		                  WHEN '3' THEN t.doche_qty2 /*1등급*/
		                END END AS cur_doche,
		               t.suyul_dusu AS sum_dusu,
		               CASE #searchKeyword# /*원료구분*/
		                  WHEN '1' THEN t.doche_qty1 /*암퇘지*/
		                  WHEN '2' THEN t.doche_qty3 /*더느림*/
		                  WHEN '3' THEN t.doche_qty2 /*1등급*/
		               END AS sum_doche
		          FROM openmps.mp_yield_info_m t
		         WHERE t.corp_code = #corpCode#		           
		           <isNotEmpty property="plantCode">
				   AND t.grup_plant = #plantCode#
				   </isNotEmpty>
		           AND t.work_date BETWEEN substring(#strtDate#, 1, 6) || '01' AND #strtDate#) a
	</select>	
	
	<select id="PP0605mpBarProMDAO.selectMpBarProMList_D" parameterClass="PP0605mpBarProMSerarchVO" resultClass="egovMap">
		SELECT large_code,
		       lcode as pro_lcode,
		       pro_code,
		       pro_name,
		       box_dosu as box_san_dusu,
		       qty as san_qty,
		       weig as san_weig,
		       prdt_dosu as san_dosu,
		       prdt_dosu / cur_doche * 100 as san_rate,
		       sum_qty,
		       sum_weig,
		       sum_prdt_dosu as sum_dosu,
		       sum_prdt_dosu / sum_doche * 100 as sum_rate
		  FROM (
				SELECT CASE WHEN GROUPING(a.large_code) = 1 THEN '합계' ELSE a.large_code END,       
				       CASE WHEN GROUPING(a.large_code) = 1 THEN NULL ELSE MAX(b.code_name) END AS lcode,       
				       CASE WHEN GROUPING(a.large_code, a.pro_code) = 1 THEN '소계' ELSE a.pro_code END,
				       CASE WHEN GROUPING(a.large_code, a.pro_code) = 1 THEN NULL ELSE MAX(a.pro_name) END AS pro_name, 
				       CASE WHEN GROUPING(a.large_code, a.pro_code) = 1 THEN NULL ELSE MAX(a.box_dosu) END AS box_dosu,
				       SUM(qty) AS qty,
				       SUM(weig) AS weig,
				       SUM(prdt_dosu) AS prdt_dosu,
				       SUM(sum_qty) AS sum_qty,
				       SUM(sum_weig) AS sum_weig,
				       SUM(sum_prdt_dosu) AS sum_prdt_dosu
				  FROM (SELECT a.corp_code,
				               b.large_code,
				               b.pro_code,
				               b.pro_name,
				               b.ipsu_cnt AS box_dosu,
				               1 AS qty,
				               a.box_weig AS weig,
				               1 * b.ipsu_cnt AS prdt_dosu,
				               0 AS sum_qty,
				               0 AS sum_weig,
				               0 AS sum_prdt_dosu
				          FROM openmps.mp_bar_pro_m a, openmps.mp_item_master_m b
				        
				         WHERE a.corp_code = #corpCode#
				           AND a.pro_date = #strtDate#
				           AND a.plant_code IN (SELECT plant_code
				                                  FROM openmps.tm_platxm
				                                 WHERE corp_code = #corpCode#
				                                   <isNotEmpty property="plantCode">
												   AND grup_plant = #plantCode#
												   </isNotEmpty>				                                   
				                                   )
				           AND a.dele_yn = 'N'
				           AND a.prdt_type = '1'
				           AND a.corp_code = b.corp_code
				           AND a.pro_code = b.pro_code
				           AND b.cm_rpt_type = #searchKeyword# /*1:암퇘지, 2:더느림, 3:1등급*/
				        UNION ALL
				        SELECT a.corp_code,
				               b.large_code,
				               b.pro_code,
				               b.pro_name,
				               b.ipsu_cnt AS box_dosu,
				               0,
				               0,
				               0,
				               1 AS sum_qty,
				               a.box_weig AS sum_weig,
				               1 * b.ipsu_cnt AS sum_prdt_dosu
				          FROM openmps.mp_bar_pro_m a, openmps.mp_item_master_m b
				         WHERE a.corp_code = #corpCode#
				           AND a.pro_date BETWEEN substring(#strtDate#, 1, 6) || '01' AND #strtDate#
				           AND a.plant_code IN (SELECT plant_code
				                                  FROM openmps.tm_platxm
				                                 WHERE corp_code = #corpCode#
				                                   <isNotEmpty property="plantCode">
												   AND grup_plant = #plantCode#
												   </isNotEmpty>												   
				                                   )
				           AND a.dele_yn = 'N'
				           AND a.prdt_type = '1'
				           AND a.corp_code = b.corp_code
				           AND a.pro_code = b.pro_code
				           AND b.cm_rpt_type = #searchKeyword# /*1:암퇘지, 2:더느림, 3:1등급*/   
				        ) a
				  LEFT JOIN openmps.tm_codexd b ON a.corp_code = b.corp_code
				                              AND a.large_code = b.code_id
				                              AND b.group_code = 'MP006'
				 GROUP BY ROLLUP(a.large_code, a.pro_code)
				 HAVING GROUPING(a.large_code, a.pro_code) = 0 ) a,
		       (SELECT SUM(cur_doche) AS cur_doche, SUM(sum_doche) AS sum_doche
		          FROM (SELECT
				                 CASE
				                    WHEN work_date = #strtDate# THEN
				                     CASE #searchKeyword# /*원료구분*/
				                    WHEN '1' THEN t.doche_qty1 /*암퇘지*/
				                    WHEN '2' THEN t.doche_qty3 /*더느림*/
				                    WHEN '3' THEN t.doche_qty2 /*1등급*/
				                  END END AS cur_doche,
				                 CASE #searchKeyword# /*원료구분*/
				                    WHEN '1' THEN t.doche_qty1 /*암퇘지*/
				                    WHEN '2' THEN t.doche_qty3 /*더느림*/
				                    WHEN '3' THEN t.doche_qty2 /*1등급*/
				                 END AS sum_doche
				            FROM openmps.mp_yield_info_m t
				           WHERE t.corp_code = #corpCode#
				             <isNotEmpty property="plantCode">
							 AND t.grup_plant = #plantCode#
							 </isNotEmpty>				             
				             AND t.work_date BETWEEN substring(#strtDate#, 1, 6) || '01' AND #strtDate#) a) b 
	</select>	
	
	<select id="PP0605mpBarProMDAO.selectMpBarProMListTotCnt_S" parameterClass="PP0605mpBarProMSerarchVO" resultClass="int">
	</select>

</sqlMap>