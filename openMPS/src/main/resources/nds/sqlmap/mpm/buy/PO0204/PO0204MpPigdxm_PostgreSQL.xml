<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="PO0204MpPigdxm">
	
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="PO0204mpPigdxmSerarchVO" type="nds.mpm.buy.PO0102.vo.MpPigdxmVO"/>
	<update id="PO0204mpPigdxmDAO.updateMpPigdxm">
		<![CDATA[
			UPDATE openmps.mp_pigdxm
			SET 
				dele_yn = 'Y'
				, md_user=#mdUser#
				, md_date=now()
						WHERE corp_code=#corpCode#
								AND doch_date=#dochDate#
								AND cust_code=#custCode#
				]]>
	</update>
	<sql id="selectWhere_fragment">
	  	from
			(
				select
				 aaa.corp_code
				 ,aaa.doch_date
				,aaa.cust_code
				,aaa.sex_no1
				,aaa.sex_no2
				,aaa.sex_no3
				,aaa.sex_no_sum
				, aaa.pig_weig3
				, aaa.pig_weig2
				, aaa.pig_weig1
				, (aaa.pig_weig1 / aaa.sex_no_sum)::numeric(11,2) as pig_weig1_ratio 
				, ((oth_kind0 + oth_kind1 + oth_kind2) + oth_kind3) - pig_pric7 + pig_pric9 as nong_jigub_kum
				, bbb.a_tot_price1::numeric
				, bbb.a1_tot_price1::numeric
				, ccc.avga_tot_price1
				, ccc.avga1_tot_price1
				from
				(
					select 
			
					bb.corp_code
					,aa.doch_date
					,aa.cust_code
					,aa.sex_no1
					,aa.sex_no2
					,aa.sex_no3
					,(aa.sex_no1 + aa.sex_no2 + aa.sex_no3) sex_no_sum
					, sum(bb.oth_kind0) oth_kind0
					, sum(bb.oth_kind1) oth_kind1
					, sum(bb.oth_kind2) oth_kind2
					, sum(bb.oth_kind3) oth_kind3
					, sum(aa.pig_pric5) pig_pric5
					, sum(aa.pig_pric7) pig_pric7
					, sum(aa.pig_pric9) pig_pric9
					, pig_weig3
					, pig_weig2
					, pig_weig1
					from
					(
						<![CDATA[
						SELECT
							a.corp_code
							,a.doch_date
							, a.cust_code
							, sum(case when a.sex_no='1' then 1 else 0 end) sex_no1
							, sum(case when a.sex_no='2' then 1 else 0 end) sex_no2
							, sum(case when a.sex_no='3' then 1 else 0 end) sex_no3
							, sum(a.pig_weig3) as pig_weig3
							, sum(a.pig_weig2) as pig_weig2
							, sum(a.pig_weig1) as pig_weig1
							
							
							, a.pig_pric8 + a.pig_pric13	
			
							, a.pig_pric5
							, a.pig_pric7
							, a.pig_pric9
								
							FROM 
								openmps.mp_pigdxm a
							left outer join openmps.mp_pigexm b on (
								a.corp_code = b.corp_code and a.fac_kind = b.fac_kind and a.fac_code = b.fac_code
								and b.start_date <= #strtDate# and b.end_date >= #lastDate#
								)
							where 
								a.corp_code = #corpCode#
							and a.doch_date between #strtDate# and #lastDate#
							and a.dele_yn = 'N'
							]]>
							<isNotEmpty prepend="and" property="facKind">
							a.fac_kind = #facKind#
							</isNotEmpty>
							<isNotEmpty prepend="and" property="buyType">
							a.buy_type = #buyType#
							</isNotEmpty>
							<isNotEmpty prepend="and" property="brandCode">
							a.brand_code = #brandCode#
							</isNotEmpty>
							<isNotEmpty prepend="and" property="custCode">
							a.rep_cust = #custCode#
							</isNotEmpty>
							group by 
							a.corp_code
							, a.doch_date
							, a.cust_code
							, a.pig_grade	
							, a.pig_pric8
							, a.pig_pric13
							, a.pig_pric5
							, a.pig_pric7
							, a.pig_pric9		
					) aa
					left outer join 
						(
							select 
							corp_code,doch_date,cust_code
							, sum(case when c.oth_kind='0' then c.oth_pric else 0 end) oth_kind0
							, sum(case when c.oth_kind='1' then c.oth_pric else 0 end) oth_kind1
							, sum(case when c.oth_kind='2' then c.oth_pric else 0 end) oth_kind2
							, sum(case when c.oth_kind='3' then c.oth_pric else 0 end) oth_kind3
							from
							openmps.mp_pigoxm c
							where c.doch_date between #strtDate# and #lastDate#
							and c.dele_yn = 'N'
							group by corp_code,doch_date,cust_code
						) bb
					on ( aa.corp_code = bb.corp_code and aa.cust_code = bb.cust_code )
					group by
					bb.corp_code
					,aa.doch_date
					,aa.cust_code
					,aa.sex_no1
					,aa.sex_no2
					,aa.sex_no3
					, aa.pig_weig3
					, aa.pig_weig2
					, aa.pig_weig1
				) aaa
				left outer join openmps.mp_pigixm bbb on (aaa.corp_code = bbb.corp_code and aaa.doch_date = bbb.jiyuk_date)
				left outer join 
				(
					select 
					avg(a_tot_price1::numeric)::numeric(11,0) as avga_tot_price1
					,avg(a1_tot_price1::numeric)::numeric(11,0) as avga1_tot_price1
					from 
					openmps.mp_pigixm a
					where a.corp_code = #corpCode#
					and a.jiyuk_date between to_char(#strtDate#::date, 'YYYYMM') || '01' and to_char(#lastDate#::date, 'YYYYMM') || '31' 
					and a.dele_yn = 'N'
				) ccc on (1=1)
			) ttt
	</sql>
	<select id="PO0204mpPigdxmDAO.selectMpPigdxmList_D" parameterClass="PO0204mpPigdxmSerarchVO" resultClass="egovMap">
			select
				corp_code
				,doch_date
				,cust_code
				,sex_no1
				,sex_no2
				,sex_no3
				,sex_no_sum
				,pig_weig3
				,pig_weig2
				,pig_weig1
				,pig_weig1_ratio as pig_weig4
				,(nong_jigub_kum)::numeric(11,0) as pig_pric2
				,avga_tot_price1 as a_tot_price1
				,(nong_jigub_kum / pig_weig1 / avga_tot_price1)::numeric(11,0) as a_tot_price1_month	
				,a_tot_price1 as a_tot_price2
				,(nong_jigub_kum / pig_weig1 / a_tot_price1)::numeric(11,0) as a_tot_price_per
				,avga1_tot_price1 as a1_tot_price1
				,(nong_jigub_kum / pig_weig1 / avga1_tot_price1)::numeric(11,0) as a1_tot_price_month	
				,(nong_jigub_kum / pig_weig1 / a1_tot_price1)::numeric(11,0) as a1_tot_price_per
				,a1_tot_price1 as a1_tot_price2
		<include refid="selectWhere_fragment"/>			
	</select>	
	<select id="PO0204mpPigdxmDAO.selectMpPigdxmListTotCnt_S" parameterClass="PO0204mpPigdxmSerarchVO" resultClass="int">
		SELECT count(*)
		<include refid="selectWhere_fragment"/>
	</select>

</sqlMap>
