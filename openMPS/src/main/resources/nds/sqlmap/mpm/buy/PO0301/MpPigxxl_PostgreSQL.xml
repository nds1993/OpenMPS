<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="PO0301MpPigxxl">
	
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="mpPigxxlSerarchVO" type="nds.mpm.buy.PO0301.vo.MpPigxxlVO"/>
	
	<resultMap id="mpPigxxl" class="nds.mpm.buy.PO0301.vo.MpPigxxlVO">
		<result property="corpCode" column="corp_code" columnIndex="1"/>
		<result property="startDate" column="start_date" columnIndex="2"/>
		<result property="rowNum" column="row_num" columnIndex="3"/>
		<result property="scraAmt" column="scra_amt" columnIndex="4"/>
		<result property="othAmt" column="oth_amt" columnIndex="5"/>
		<result property="endDate" column="end_date" columnIndex="6"/>
		<result property="exchNum" column="exch_num" columnIndex="7"/>
		<result property="memo" column="memo" columnIndex="8"/>
		<result property="deleYn" column="dele_yn" columnIndex="9"/>
		<result property="mdUser" column="md_user" columnIndex="10"/>
		<result property="mdDate" column="md_date" columnIndex="11"/>
		<result property="crUser" column="cr_user" columnIndex="12"/>
		<result property="crDate" column="cr_date" columnIndex="13"/>
	</resultMap>
	
	<insert id="PO0301mpPigxxlDAO.insertMpPigxxl_S">
		<selectKey resultClass="java.lang.String" keyProperty="rowNum">
          select #startDate# || #rowNum#
      	</selectKey>
		<![CDATA[
			INSERT INTO openmps.mp_pigxxl 
				( corp_code
				  , start_date
				  , row_num
				  , scra_amt
				  , oth_amt
				  , end_date
				  , exch_num
				  , memo
				  , dele_yn
				  , md_user
				  , md_date
				  , cr_user
				  , cr_date )
			VALUES ( #corpCode#
				  , #startDate#
				  , (select coalesce(count(row_num),0)+1 from openmps.mp_pigxxl where a.corp_code and start_date = #startDate#)
				  , #scraAmt#::numeric(11,0)
				  , #othAmt#::numeric(11,0)
				  , #endDate#
				  , #exchNum#::numeric(11,2)
				  , #memo#
				  , 'N'
				  , #mdUser#
				  , #mdDate#
				  , #crUser#
				  , now() )
			ON CONFLICT (corp_code, start_date, row_num)
    		DO UPDATE SET
    			scra_amt=#scraAmt#::numeric(11,0)
				, oth_amt=#othAmt#::numeric(11,0)
				, end_date=#endDate#
				, exch_num=#exchNum#::numeric(11,2)
				, memo=#memo#
				, md_user=#mdUser#
				, md_date=now()
		]]>
	</insert>
	
	<update id="PO0301mpPigxxlDAO.updateMpPigxxl_S">
		<![CDATA[
			UPDATE openmps.mp_pigxxl
			SET scra_amt=#scraAmt#
				, oth_amt=#othAmt#
				, end_date=#endDate#
				, exch_num=#exchNum#
				, memo=#memo#
				, md_user=#mdUser#
				, md_date=now()
			where corp_code = #corpCode#
			and start_date = #startDate#
			and row_num = #rowNum#
			]]>
	</update>
	
	<delete id="PO0301mpPigxxlDAO.deleteMpPigxxl_S">
		<![CDATA[
			UPDATE openmps.mp_pigxxl
			SET dele_yn = 'Y'
				, md_user=#mdUser#
				, md_date=now()
			where corp_code = #corpCode#
			and start_date = #startDate#
			and row_num = #rowNum#	
			]]>
	</delete>
	
	<select id="PO0301mpPigxxlDAO.selectMpPigxxl_S" resultMap="mpPigxxl">
		<![CDATA[
			SELECT
				corp_code
				, start_date
				, row_num
				, scra_amt
				, oth_amt
				, end_date
				, exch_num
				, memo
				, dele_yn
				, md_user
				, md_date
				, cr_user
				, cr_date
			FROM openmps.mp_pigxxl
			]]>
	</select>
	<sql id="selectWhere_fragment">
		FROM openmps.mp_pigxxl a
		where corp_code=#corpCode#
		and start_date =#startDate#
		and dele_yn = 'N'
		<dynamic>
			<isNotEmpty property="custCode">
			</isNotEmpty>
		</dynamic>
	</sql>
	<select id="PO0301mpPigxxlDAO.selectMpPigxxlList_D" parameterClass="mpPigxxlSerarchVO" resultClass="egovMap">
		SELECT
				corp_code
				, start_date
				, row_num
				, scra_amt
				, oth_amt
				, end_date
				, exch_num
				, memo
				, dele_yn
				, md_user
				, md_date
				, cr_user
				, cr_date
		<include refid="selectWhere_fragment"/>
	</select>	
	<select id="PO0301mpPigxxlDAO.selectMpPigxxlListTotCnt_S" parameterClass="mpPigxxlSerarchVO" resultClass="int">
		select count(*)
		<include refid="selectWhere_fragment"/>
	</select>

</sqlMap>
