<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="SD0505MpOrderH">
	
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="SD0505mpOrderHSerarchVO" type="nds.mpm.sales.SD0505.vo.MpOrderHDefaultVO"/>
	
	<select id="SD0505mpOrderHDAO.selectMpOrderHList_D" parameterClass="SD0505mpOrderHSerarchVO" resultClass="egovMap">
	<![CDATA[	
		select		tt1.user_name,
					tt1.salesman,
					tt1.cust_code,
					tt1.cust_name,
					tt1.last_unpay,
					tt1.sale_amt,
					tt1.rece_amt,
					tt1.t_last_unpay,
					case
						when 	tt1.sale_amt = 0
						then	0
						else
								trunc((tt1.t_last_unpay/tt1.sale_amt)*to_number(to_char(to_date(to_char(DATE_TRUNC('MONTH', to_date(#lastDate#,'yyyymmdd')) + INTERVAL '1 MONTH -1 day','yyyymmdd'),'yyyymmdd') - to_date(substr(#lastDate#,0,7)||'01','yyyymmdd') + 1,'99'),'99')) 
					end as turnover,
					tt1.non_deal
		from		(		
					select 	t4.user_name, 
								t4.salesman,
								t1.cust_code,
								t4.cust_name,
								sum(t1.last_unpay) last_unpay,
								sum(t2.sale_amt) sale_amt,
								sum(t3.rece_amt) rece_amt,
								sum(t1.last_unpay + t2.sale_amt - t3.rece_amt) as t_last_unpay,
								to_date(to_char(current_timestamp,'yyyymmdd'),'yyyymmdd') - to_date(t6.sale_date,'yyyymmdd') non_deal
					from 		(
								select	corp_code,
											cust_code,
											sum(last_unpay) last_unpay
								from		mp_last_unpayment 
								where		corp_code = #corpCode#
								and		to_date(unpay_yymm,'yyyymm') = to_date(substr(to_char(to_date(#lastDate#,'yyyymmdd') + INTERVAL '- 1 MONTH','yyyymmdd'),0,7),'yyyymm')
								group
								by			corp_code, 
											cust_code
								)t1, 
							   (
							   select	cust_code,
							   			SUM(sale_amt+sale_vat) sale_amt
								from		mp_cust_record
								where		to_date(sale_date,'yyyymmdd') 	between to_date(#strtDate#,'yyyymmdd')
																						and     to_date(#lastDate#,'yyyymmdd')
								and		corp_code = #corpCode#
								group
								by			cust_code
								)t2, 
								(
								select	tt1.cust_code,
											sum(tt1.rece_amt) rece_amt
								from		(
											select	t1.cust_code,
														sum(t1.rece_amt) rece_amt
											from		mp_cust_receipt  t1,
														(
														select 	t1.corp_code,
																	t3.salesman_cust as cust_code,
																	t2.dept_code,
																	t1.salesman,
																	t2.user_name
														from 		mp_cust_hist t1,
																	tm_userxm t2,
																	mp_salesman_cust t3,
																	mp_cust_info t4
														where		start_date <= #lastDate#
														and		last_date >= #lastDate#
														and		t1.salesman = t2.user_code
														and		(t2.dept_code = #teamCode# or t2.team_code = #teamCode# or t2.head_code = #teamCode#)
														and		t1.salesman = t3.salesman
														and		t1.corp_code = t2.corp_code
														and		t1.corp_code = t3.corp_code
														and		t1.cust_code = t3.salesman_cust
														and		t1.corp_code = #corpCode#
														and		t1.cust_code = t4.cust_code
														and		t1.corp_code = t4.corp_code
														and		t4.rece_comb = '1'
														) t2
											where		to_date(rece_date,'yyyymmdd')	between to_date(#strtDate#,'yyyymmdd')
																								and	  to_date(#lastDate#,'yyyymmdd')
											and		t1.cust_code = t2.cust_code
											group
											by			t1.cust_code
											union 
											select	t2.cust_code,
														sum(t1.rece_amt) rece_amt
											from		mp_cust_receipt  t1,
														(
														select 	t1.corp_code,
																	t3.salesman_cust as cust_code,
																	t2.dept_code,
																	t1.salesman,
																	t2.user_name,
																	t4.rece_comb_cust
														from 		mp_cust_hist t1,
																	tm_userxm t2,
																	mp_salesman_cust t3,
																	mp_cust_info t4
														where		start_date <= #lastDate#
														and		last_date >= #lastDate#
														and		t1.salesman = t2.user_code
														and		(t2.dept_code = #teamCode# or t2.team_code = #teamCode# or t2.head_code = #teamCode#)
														and		t1.salesman = t3.salesman
														and		t1.corp_code = t2.corp_code
														and		t1.corp_code = t3.corp_code
														and		t1.cust_code = t3.salesman_cust
														and		t1.corp_code = #corpCode#
														and		t1.corp_code = t4.corp_code
														and		t1.cust_code = t4.cust_code
														and		t4.rece_comb = '2'
														) t2
											where		to_date(rece_date,'yyyymmdd')	between to_date(#strtDate#,'yyyymmdd')
																								and	  to_date(#lastDate#,'yyyymmdd')
											and		t1.cust_code = t2.rece_comb_cust
											group
											by			t2.cust_code
											) tt1
								group
								by			tt1.cust_code
								)t3,
								(
								select 	t1.corp_code,
											t3.salesman_cust as cust_code,
											t2.dept_code,
											t1.salesman,
											t2.user_name,
											t4.cust_name
								from 		mp_cust_hist t1,
											tm_userxm t2,
											mp_salesman_cust t3,
											mp_cust_info t4
								where		start_date <= #lastDate#
								and		last_date >= #lastDate#
								and		t1.salesman = t2.user_code
								and		(t2.dept_code = #teamCode# or t2.team_code = #teamCode# or t2.head_code = #teamCode#)
								and		t1.salesman = t3.salesman
								and		t1.corp_code = t2.corp_code
								and		t1.corp_code = t3.corp_code
								and		t1.cust_code = t3.salesman_cust
								and		t1.corp_code = #corpCode#
								and		t1.corp_code = t4.corp_code
								and		t1.cust_code = t4.cust_code
								)t4,
								(
								select	cust_code,
											max(sale_date) sale_date
								from		mp_cust_record 
								where		corp_code = #corpCode#
								group
								by			cust_code
								)t6
					where		t1.cust_code = t2.cust_code
					and		t1.cust_code = t3.cust_code
					and		t1.cust_code = t4.cust_code
					and		t1.cust_code = t6.cust_code
					group
					by			t4.user_name, 
								t4.salesman,
								t1.cust_code,
								t4.cust_name,
								t6.sale_date	
					) tt1
		order
		by			tt1.user_name,
					tt1.cust_code	
	]]>	
	</select>	
	<select id="SD0505mpOrderHDAO.selectDetailMpOrderHList_D" parameterClass="SD0505mpOrderHSerarchVO" resultClass="egovMap">
		select		delv_date,
					case 
						when	gubn = '1'
						then	ordr_no
						else  ' '
					end as ordr_no,
					case 
						when	gubn = '1'
						then	ordr_type
						else  ' '
					end as ordr_type,
					case 
						when	gubn = '1'
						then	ordr_type_nm
						else  ' '
					end as ordr_type_nm,
					case 
						when	gubn = '1'
						then	delv_amt
						else  0
					end as   delv_amt,
					case 
						when	gubn = '2'
						then	ordr_no
						else  ' '
					end as rece_no,
					case 
						when	gubn = '2'
						then	ordr_type
						else  ' '
					end as rece_type,
					case 
						when	gubn = '2'
						then	ordr_type_nm
						else  ' '
					end as rece_type_nm,
					case 
						when	gubn = '2'
						then	delv_amt
						else  0
					end as rece_amt,
					last_unpay
		from
					(
					select	delv_Date,
								ordr_no,
								ordr_type,
								t2.code_name ordr_type_nm,
								delv_amt,
								'1' gubn
					from		mp_order_h t1,
								tm_codexd  t2
					where		t1.corp_code = #corpCode#
					and		t1.ordr_cust = #custCode#
					and		t1.delv_date 	between 	#strtDate#
													and		#lastDate#
					and		t1.corp_code = t2.corp_code
					and		t2.group_code = 'SD017'
					and		t1.ordr_type = t2.code_id
					union
					select	rece_date ,
								rece_code ,
								rece_type,
								t2.code_name rece_type_nm,
								rece_amt,
								'2' gubn
					from
								(
								select	t1.cust_code,
											t1.cust_code payer,
											t1.rece_amt,
											t1.rece_date,
											t1.corp_code,
											t1.rece_code,
											t1.rece_type
								from		mp_rece_info t1,
											mp_cust_info t2
								where		t1.corp_code = #corpCode#
								and		t1.corp_code = t2.corp_code
								and		t1.cust_code = t2.cust_code
								and 		t2.rece_comb = '1'
								and		t1.rece_date 	between 	#strtDate#
																and		#lastDate#
								and		t1.cust_code = #custCode#
								union
								select	t2.cust_code,
											t1.cust_code payer,
											t1.rece_amt,
											t1.rece_date,
											t1.corp_code,
											t1.rece_code,
											t1.rece_type
								from		mp_rece_info t1,
											mp_cust_info t2
								where		t1.corp_code = #corpCode#
								and		t1.corp_code = t2.corp_code
								and		t1.cust_code = t2.rece_comb_cust
								and		t2.cust_code = #custCode#
								and 		t2.rece_comb = '2'
								and		t1.rece_date 	between 	#strtDate#
																and		#lastDate#
								)	t1,
								tm_codexd t2
					where		t1.corp_code = t2.corp_code
					and		t1.rece_type = t2.code_id
					and		t2.group_code = 'SD015'				
					)tt1,
					mp_last_unpayment tt2
		where		tt2.corp_code = #corpCode#
		and		tt2.cust_code = #custCode#
		and		tt2.unpay_yymm = to_char(to_date(substr(#lastDate#,0,7),'yyyymm')+(-1*'1 month' ::INTERVAL),'yyyymm')
	</select>	
</sqlMap>
