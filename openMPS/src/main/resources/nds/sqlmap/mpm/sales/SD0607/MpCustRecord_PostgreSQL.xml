<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="SD0607MpCustRecord">
	
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="SD0607mpCustRecordSerarchVO" type="nds.mpm.sales.SD0607.vo.MpCustRecordVO"/>
	
	<select id="SD0607mpCustRecordDAO.selectMpCustRecordList_D" parameterClass="SD0607mpCustRecordSerarchVO" resultClass="egovMap">
		SELECT T1.TITLE, T1.mon1, T1.mon2, T1.mon3, T1.mon4, T1.mon5, T1.mon6, T1.mon7, T1.mon8, T1.mon9, T1.mon10, T1.mon11, T1.mon12
			FROM (
				SELECT 
				    '1' AS ORDER,
					'목표중량' AS TITLE,
					SUM(CASE WHEN C.TARGET_YYMM =#strtYyyy#||'01' THEN C.TARGET_WEIGHT ELSE 0 END) as mon1,
					SUM(CASE WHEN C.TARGET_YYMM =#strtYyyy#||'02' THEN C.TARGET_WEIGHT ELSE 0 END) as mon2,
					SUM(CASE WHEN C.TARGET_YYMM =#strtYyyy#||'03' THEN C.TARGET_WEIGHT ELSE 0 END) as mon3,
					SUM(CASE WHEN C.TARGET_YYMM =#strtYyyy#||'04' THEN C.TARGET_WEIGHT ELSE 0 END) as mon4,
					SUM(CASE WHEN C.TARGET_YYMM =#strtYyyy#||'05' THEN C.TARGET_WEIGHT ELSE 0 END) as mon5, 
					SUM(CASE WHEN C.TARGET_YYMM =#strtYyyy#||'06' THEN C.TARGET_WEIGHT ELSE 0 END) as mon6, 
					SUM(CASE WHEN C.TARGET_YYMM =#strtYyyy#||'07' THEN C.TARGET_WEIGHT ELSE 0 END) as mon7,
					SUM(CASE WHEN C.TARGET_YYMM =#strtYyyy#||'08' THEN C.TARGET_WEIGHT ELSE 0 END) as mon8,
					SUM(CASE WHEN C.TARGET_YYMM =#strtYyyy#||'09' THEN C.TARGET_WEIGHT ELSE 0 END) as mon9,
					SUM(CASE WHEN C.TARGET_YYMM =#strtYyyy#||'10' THEN C.TARGET_WEIGHT ELSE 0 END) as mon10,
					SUM(CASE WHEN C.TARGET_YYMM =#strtYyyy#||'11' THEN C.TARGET_WEIGHT ELSE 0 END) as mon11,
					SUM(CASE WHEN C.TARGET_YYMM =#strtYyyy#||'12' THEN C.TARGET_WEIGHT ELSE 0 END) as mon12
				FROM (
					SELECT A.TARGET_YYMM AS TARGET_YYMM, SUM(A.TARGET_WEIGHT) AS TARGET_WEIGHT
						FROM MP_CUSTGOAL_YYMM A INNER JOIN MP_CUST_HIST B ON A.CUST_CODE = B.CUST_CODE
					WHERE TARGET_YYMM BETWEEN  #strtYyyy#||'01' AND  #strtYyyy#||'12' 
					<isNotEmpty property="teamCode">
						<isNotEqual property="teamCode" compareValue="ALL">
							 AND B.PART_CODE = #teamCode# 
						</isNotEqual>
					</isNotEmpty>       
							AND B.SALESMAN = #salesman#
							AND B.CUST_CODE = #custCode# 
				GROUP BY A.TARGET_YYMM ) C
				UNION
				SELECT
				    '2' AS ORDER,
					'금년실적' AS TITLE,
					SUM(CASE WHEN D.SALE_DATE =#strtYyyy#||'01' THEN D.SALE_WEIGHT ELSE 0 END) as mon1,
					SUM(CASE WHEN D.SALE_DATE =#strtYyyy#||'02' THEN D.SALE_WEIGHT ELSE 0 END) as mon2,
					SUM(CASE WHEN D.SALE_DATE =#strtYyyy#||'03' THEN D.SALE_WEIGHT ELSE 0 END) as mon3,
					SUM(CASE WHEN D.SALE_DATE =#strtYyyy#||'04' THEN D.SALE_WEIGHT ELSE 0 END) as mon4,
					SUM(CASE WHEN D.SALE_DATE =#strtYyyy#||'05' THEN D.SALE_WEIGHT ELSE 0 END) as mon5, 
					SUM(CASE WHEN D.SALE_DATE =#strtYyyy#||'06' THEN D.SALE_WEIGHT ELSE 0 END) as mon6, 
					SUM(CASE WHEN D.SALE_DATE =#strtYyyy#||'07' THEN D.SALE_WEIGHT ELSE 0 END) as mon7,
					SUM(CASE WHEN D.SALE_DATE =#strtYyyy#||'08' THEN D.SALE_WEIGHT ELSE 0 END) as mon8,
					SUM(CASE WHEN D.SALE_DATE =#strtYyyy#||'09' THEN D.SALE_WEIGHT ELSE 0 END) as mon9,
					SUM(CASE WHEN D.SALE_DATE =#strtYyyy#||'10' THEN D.SALE_WEIGHT ELSE 0 END) as mon10,
					SUM(CASE WHEN D.SALE_DATE =#strtYyyy#||'11' THEN D.SALE_WEIGHT ELSE 0 END) as mon11,
					SUM(CASE WHEN D.SALE_DATE =#strtYyyy#||'12' THEN D.SALE_WEIGHT ELSE 0 END) as mon12 
				FROM (
				SELECT C.SALE_DATE AS SALE_DATE, SUM(C.SALE_WEIGHT) AS SALE_WEIGHT 
				FROM (
					SELECT SUBSTR(A.SALE_DATE, 0, 7) AS SALE_DATE, A.SALE_WEIGHT 
						FROM MP_CUST_RECORD A INNER JOIN MP_CUST_HIST B ON A.CUST_CODE = B.CUST_CODE
					WHERE A.SALE_DATE BETWEEN #strtYyyy#||'0101' AND  #strtYyyy#||'1231' 
					<isNotEmpty property="teamCode">
						<isNotEqual property="teamCode" compareValue="ALL">
							AND B.PART_CODE = #teamCode# 
						</isNotEqual>
					</isNotEmpty> 
							AND B.SALESMAN = #salesman#
							AND B.CUST_CODE = #custCode#  ) C
				GROUP BY C.SALE_DATE ) D
				UNION
				SELECT
				    '3' AS ORDER,
					'전년실적' AS TITLE,                     
					SUM(CASE WHEN D.SALE_DATE =#strtPreYyyy#||'01' THEN D.SALE_WEIGHT ELSE 0 END) as mon1,
					SUM(CASE WHEN D.SALE_DATE =#strtPreYyyy#||'02' THEN D.SALE_WEIGHT ELSE 0 END) as mon2,
					SUM(CASE WHEN D.SALE_DATE =#strtPreYyyy#||'03' THEN D.SALE_WEIGHT ELSE 0 END) as mon3,
					SUM(CASE WHEN D.SALE_DATE =#strtPreYyyy#||'04' THEN D.SALE_WEIGHT ELSE 0 END) as mon4,
					SUM(CASE WHEN D.SALE_DATE =#strtPreYyyy#||'05' THEN D.SALE_WEIGHT ELSE 0 END) as mon5, 
					SUM(CASE WHEN D.SALE_DATE =#strtPreYyyy#||'06' THEN D.SALE_WEIGHT ELSE 0 END) as mon6, 
					SUM(CASE WHEN D.SALE_DATE =#strtPreYyyy#||'07' THEN D.SALE_WEIGHT ELSE 0 END) as mon7,
					SUM(CASE WHEN D.SALE_DATE =#strtPreYyyy#||'08' THEN D.SALE_WEIGHT ELSE 0 END) as mon8,
					SUM(CASE WHEN D.SALE_DATE =#strtPreYyyy#||'09' THEN D.SALE_WEIGHT ELSE 0 END) as mon9,
					SUM(CASE WHEN D.SALE_DATE =#strtPreYyyy#||'10' THEN D.SALE_WEIGHT ELSE 0 END) as mon10,
					SUM(CASE WHEN D.SALE_DATE =#strtPreYyyy#||'11' THEN D.SALE_WEIGHT ELSE 0 END) as mon11,
					SUM(CASE WHEN D.SALE_DATE =#strtPreYyyy#||'12' THEN D.SALE_WEIGHT ELSE 0 END) as mon12 
				FROM (
				SELECT C.SALE_DATE AS SALE_DATE, SUM(C.SALE_WEIGHT) AS SALE_WEIGHT 
				FROM (
					SELECT SUBSTR(A.SALE_DATE, 0, 7) AS SALE_DATE, A.SALE_WEIGHT 
						FROM MP_CUST_RECORD A INNER JOIN MP_CUST_HIST B ON A.CUST_CODE = B.CUST_CODE
					WHERE  A.SALE_DATE BETWEEN  #strtPreYyyy#||'0101' AND  #strtPreYyyy#||'1231' 
					<isNotEmpty property="teamCode">
						<isNotEqual property="teamCode" compareValue="ALL">
							AND B.PART_CODE = #teamCode# 
						</isNotEqual>
					</isNotEmpty> 
							AND B.SALESMAN = #salesman#
							AND B.CUST_CODE = #custCode#  ) C
				GROUP BY C.SALE_DATE ) D
			) T1 ORDER BY T1.ORDER 
	</select>	
	<select id="SD0607mpCustRecordDAO.selectChartMpCustRecordList" parameterClass="SD0607mpCustRecordSerarchVO" resultClass="egovMap">
		SELECT 
			(CASE WHEN SUBSTR(GOAL.TITLE, 1, 1) = '0' THEN SUBSTR(GOAL.TITLE, 2, 1) ELSE GOAL.TITLE END) AS TITLE,
			COALESCE(GOAL.TARGET_WEIGHT, 0) AS TARGET_WEIGHT, 
			COALESCE(NOW.CURYY_WEIGHT, 0) AS CURYY_WEIGHT, 
			COALESCE(PRE.BEFYY_WEIGHT, 0) AS BEFYY_WEIGHT 
		FROM 
			(SELECT SUBSTR(A.TARGET_YYMM,5,2) AS TITLE, SUM(A.TARGET_WEIGHT) AS TARGET_WEIGHT
			FROM MP_CUSTGOAL_YYMM A INNER JOIN MP_CUST_HIST B ON A.CUST_CODE = B.CUST_CODE
			WHERE TARGET_YYMM BETWEEN  #strtYyyy#||'01' AND  #strtYyyy#||'12' 
				<isNotEmpty property="teamCode">
					<isNotEqual property="teamCode" compareValue="ALL">
						AND B.PART_CODE = #teamCode# 
					</isNotEqual>
				</isNotEmpty> 
					AND B.SALESMAN = #salesman#
					AND B.CUST_CODE = #custCode#
			GROUP BY A.TARGET_YYMM) GOAL LEFT OUTER JOIN 
			(SELECT SUBSTR(C.YYMM,5,2) AS TITLE, SUM(C.SALE_WEIGHT) AS CURYY_WEIGHT
			FROM (
			SELECT SUBSTR(A.SALE_DATE, 0, 7) AS YYMM, A.SALE_WEIGHT 
			FROM MP_CUST_RECORD A INNER JOIN MP_CUST_HIST B ON A.CUST_CODE = B.CUST_CODE
			WHERE A.SALE_DATE BETWEEN  #strtYyyy#||'0101' AND  #strtYyyy#||'1231' 
				<isNotEmpty property="teamCode">
					<isNotEqual property="teamCode" compareValue="ALL">
						AND B.PART_CODE = #teamCode# 
					</isNotEqual>
				</isNotEmpty> 
					AND B.SALESMAN = #salesman#
					AND B.CUST_CODE = #custCode# ) C
			GROUP BY C.YYMM) NOW ON GOAL.TITLE = NOW.TITLE 
			LEFT OUTER JOIN (SELECT SUBSTR(C.YYMM,5,2) AS TITLE, SUM(C.SALE_WEIGHT) AS BEFYY_WEIGHT
			FROM (
			SELECT SUBSTR(A.SALE_DATE, 0, 7) AS YYMM, A.SALE_WEIGHT 
			FROM MP_CUST_RECORD A INNER JOIN MP_CUST_HIST B ON A.CUST_CODE = B.CUST_CODE
			WHERE A.SALE_DATE BETWEEN  #strtPreYyyy#||'0101' AND  #strtPreYyyy#||'1231' 
				<isNotEmpty property="teamCode">
					<isNotEqual property="teamCode" compareValue="ALL">
						AND B.PART_CODE = #teamCode# 
					</isNotEqual>
				</isNotEmpty> 
					AND B.SALESMAN = #salesman#
					AND B.CUST_CODE = #custCode#  ) C
			GROUP BY C.YYMM) PRE ON GOAL.TITLE = PRE.TITLE 
			ORDER BY GOAL.TITLE
	</select>	
</sqlMap>
