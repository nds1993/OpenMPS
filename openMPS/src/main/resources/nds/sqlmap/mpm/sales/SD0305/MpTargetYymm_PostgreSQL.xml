<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="SD0305MpTargetYymm">
	
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="SD0305mpTargetYymmSerarchVO" type="nds.mpm.sales.SD0305.vo.MpTargetYymmVO"/>
	
	<select id="SD0305mpTargetYymmDAO.selectMpTargetYymmList_H" parameterClass="SD0305mpTargetYymmSerarchVO" resultClass="egovMap">		
		WITH 
		SALES_WEIGHT AS
		(SELECT A.CORP_CODE
			,B.SALESMAN
			,B.PART_CODE
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'01' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON01
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'02' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON02
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'03' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON03
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'04' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON04
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'05' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON05
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'06' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON06
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'07' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON07
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'08' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON08
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'09' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON09
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'10' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON10
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'11' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON11
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'12' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON12
			FROM MP_CUSTGOAL_YYMM A
			LEFT OUTER JOIN MP_CUST_HIST B ON ( A.CORP_CODE = B.CORP_CODE AND A.CUST_CODE = B.CUST_CODE )
			WHERE A.CORP_CODE = #corpCode#
				AND A.TARGET_YYMM LIKE #targetYyyy#||'%'
				AND A.TARGET_YYMM BETWEEN SUBSTRING( B.START_DATE, 1, 6) AND SUBSTRING( LAST_DATE, 1, 6)
			GROUP BY A.CORP_CODE, B.SALESMAN, B.PART_CODE
		)
		,SALES_WEIGHT_SUM AS
		(SELECT SALESMAN
				,(MON01 + MON02 + MON03 + MON04 + MON05 + MON06 + MON07 + MON08 + MON09 + MON10 + MON11 + MON12) SALES_WEIGHT_SUM
			FROM SALES_WEIGHT
		)
		,SALES_WEIGHT_LAST AS
		(SELECT A.CORP_CODE, A.PART_CODE, A.SALESMAN, SUM(B.SALE_WEIGHT) SALE_WEIGHT_LAST
			FROM MP_CUST_HIST A
			LEFT OUTER JOIN MP_CUST_RECORD B ON  ( A.CORP_CODE = B.CORP_CODE AND A.CUST_CODE = B.CUST_CODE )
			WHERE A.CORP_CODE = #corpCode#
				AND B.SALE_DATE LIKE TEXT( #targetYyyy#::numeric - 1)||'%'
			GROUP BY A.CORP_CODE, A.PART_CODE, A.SALESMAN
		)
		SELECT A.CORP_CODE
				,D.DEPT_NAME
				,A.PART_CODE
				,C.USER_NAME
				,A.SALESMAN
				,E.SALE_WEIGHT_LAST
				,B.SALES_WEIGHT_SUM
				,CASE WHEN B.SALES_WEIGHT_SUM IS NULL OR B.SALES_WEIGHT_SUM = 0 THEN 0
						WHEN E.SALE_WEIGHT_LAST IS NULL OR E.SALE_WEIGHT_LAST = 0 THEN 0
						ELSE ROUND( B.SALES_WEIGHT_SUM / E.SALE_WEIGHT_LAST * 100 )
				END RATE
				,A.MON01
				,A.MON02
				,A.MON03
				,A.MON04
				,A.MON05
				,A.MON06
				,A.MON07
				,A.MON08
				,A.MON09
				,A.MON10
				,A.MON11
				,A.MON12
		FROM SALES_WEIGHT A
		LEFT OUTER JOIN SALES_WEIGHT_SUM B ON  ( A.SALESMAN = B.SALESMAN )
		LEFT OUTER JOIN TM_USERXM C ON ( A.SALESMAN  = C.USER_CODE )
		LEFT OUTER JOIN TM_DEPTXM D ON ( A.CORP_CODE = D.CORP_CODE AND A.PART_CODE = D.DEPT_CODE )
		LEFT OUTER JOIN SALES_WEIGHT_LAST E ON ( A.CORP_CODE = E.CORP_CODE AND A.SALESMAN = E.SALESMAN )
		WHERE 1=1
		<isNotEmpty property="partCode">
		AND A.PART_CODE = #partCode#
		</isNotEmpty>
		ORDER BY A.PART_CODE
		
	</select>	
	
	<select id="SD0305mpTargetYymmDAO.selectMpTargetYymmList_D" parameterClass="SD0305mpTargetYymmSerarchVO" resultClass="egovMap">
		WITH 
		SALES_WEIGHT AS
		(SELECT A.CORP_CODE
			,B.PART_CODE
			,B.SALESMAN
			,A.CUST_CODE
			,A.SALE_GROUP2
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'01' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON01
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'02' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON02
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'03' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON03
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'04' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON04
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'05' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON05
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'06' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON06
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'07' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON07
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'08' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON08
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'09' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON09
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'10' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON10
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'11' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON11
			,SUM(CASE WHEN A.TARGET_YYMM = #targetYyyy#||'12' THEN A.TARGET_WEIGHT ELSE 0 END) AS MON12
			FROM MP_CUSTGOAL_YYMM A
			LEFT OUTER JOIN MP_CUST_HIST B ON ( A.CORP_CODE = B.CORP_CODE AND A.CUST_CODE = B.CUST_CODE )
			WHERE A.CORP_CODE = #corpCode#
				AND A.TARGET_YYMM LIKE #targetYyyy#||'%'
				AND A.TARGET_YYMM BETWEEN SUBSTRING( B.START_DATE, 1, 6) AND SUBSTRING( B.LAST_DATE, 1, 6)
			GROUP BY A.CORP_CODE,B.PART_CODE,B.SALESMAN,A.CUST_CODE,A.SALE_GROUP2
		)
		,SALES_WEIGHT_SUM AS
		(SELECT CORP_CODE, SALESMAN, CUST_CODE, SALE_GROUP2
				,(MON01 + MON02 + MON03 + MON04 + MON05 + MON06 + MON07 + MON08 + MON09 + MON10 + MON11 + MON12) SALES_WEIGHT_SUM
			FROM SALES_WEIGHT
		)
		,SALES_WEIGHT_LAST AS
		(SELECT A.CORP_CODE, A.SALESMAN, B.CUST_CODE, B.SALE_GROUP2, SUM(B.SALE_WEIGHT) SALE_WEIGHT_LAST
			FROM MP_CUST_HIST A
			LEFT OUTER JOIN 	
			( SELECT B.CORP_CODE, B.CUST_CODE, B.SALE_DATE, C.SALE_GROUP1, C.SALE_GROUP2, B.SALE_WEIGHT
				FROM MP_CUST_RECORD B
				LEFT OUTER JOIN MP_ITEM_MASTER_M C ON  ( B.CORP_CODE = C.CORP_CODE AND B.PRO_CODE = C.PRO_CODE )
			) B ON ( A.CORP_CODE = B.CORP_CODE AND A.CUST_CODE = B.CUST_CODE )	
			WHERE A.CORP_CODE = #corpCode#
				AND B.SALE_DATE LIKE TEXT( #targetYyyy#::numeric - 1)||'%'
			GROUP BY A.CORP_CODE, A.SALESMAN, B.CUST_CODE, B.SALE_GROUP2
		)
		SELECT D.DEPT_NAME
				,A.PART_CODE
				,E.USER_NAME
				,A.SALESMAN
				,F.CUST_NAME
				,A.CUST_CODE
				,openmps."FN_GET_TMCODEXDNM"(A.CORP_CODE, 'SD025', A.SALE_GROUP2 ) SALE_GROUP2
				,C.SALE_WEIGHT_LAST
				,B.SALES_WEIGHT_SUM
				,CASE WHEN B.SALES_WEIGHT_SUM IS NULL OR B.SALES_WEIGHT_SUM = 0 THEN 0
						WHEN C.SALE_WEIGHT_LAST IS NULL OR C.SALE_WEIGHT_LAST = 0 THEN 0
						ELSE ROUND( B.SALES_WEIGHT_SUM / C.SALE_WEIGHT_LAST * 100 )
				END RATE
				,A.MON01
				,A.MON02
				,A.MON03
				,A.MON04
				,A.MON05
				,A.MON06
				,A.MON07
				,A.MON08
				,A.MON09
				,A.MON10
				,A.MON11
				,A.MON12
			FROM SALES_WEIGHT A
			LEFT OUTER JOIN SALES_WEIGHT_SUM B ON  ( A.CORP_CODE = B.CORP_CODE AND A.SALESMAN = B.SALESMAN AND A.CUST_CODE = B.CUST_CODE AND A.SALE_GROUP2 = B.SALE_GROUP2 )
			LEFT OUTER JOIN SALES_WEIGHT_LAST C ON  ( A.CORP_CODE = C.CORP_CODE AND A.SALESMAN = C.SALESMAN  AND A.CUST_CODE = C.CUST_CODE AND A.SALE_GROUP2 = C.SALE_GROUP2 )
			LEFT OUTER JOIN TM_DEPTXM D ON ( A.CORP_CODE = D.CORP_CODE AND A.PART_CODE = D.DEPT_CODE )
			LEFT OUTER JOIN TM_USERXM E ON ( A.CORP_CODE = E.CORP_CODE AND A.SALESMAN  = E.USER_CODE )
			LEFT OUTER JOIN MP_CUST_INFO F ON ( A.CORP_CODE = F.CORP_CODE AND A.CUST_CODE  = F.CUST_CODE )	
			WHERE A.SALESMAN = #salesman#
			<isNotEmpty property="partCode">
			AND A.PART_CODE = #partCode#
			</isNotEmpty>
		ORDER BY A.SALESMAN, A.CUST_CODE, A.SALE_GROUP2
		
	</select>	
	
	<select id="SD0305mpTargetYymmDAO.selectMpTargetYymmListTotCnt_S" parameterClass="SD0305mpTargetYymmSerarchVO" resultClass="int">
		
	</select>

</sqlMap>
