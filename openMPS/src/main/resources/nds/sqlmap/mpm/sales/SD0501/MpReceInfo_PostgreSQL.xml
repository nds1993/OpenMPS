<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="SD0501">
	
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="SD0501SerarchVO" type="nds.mpm.sales.SD0501.vo.SD0501VO"/>
	
	<resultMap id="SD0501" class="nds.mpm.sales.SD0501.vo.SD0501VO">
		<result property="corpCode" column="corp_code" columnIndex="1"/>
		<result property="receDate" column="rece_date" columnIndex="2"/>
		<result property="receCode" column="rece_code" columnIndex="3"/>
		<result property="custCode" column="cust_code" columnIndex="4"/>
		<result property="receAmt" column="rece_amt" columnIndex="5"/>
		<result property="receType" column="rece_type" columnIndex="6"/>
		<result property="teamCode" column="team_code" columnIndex="7"/>
		<result property="userCode" column="user_code" columnIndex="8"/>
		<result property="bankCode" column="bank_code" columnIndex="9"/>
		<result property="bankName" column="bank_name" columnIndex="10"/>
		<result property="bankNo" column="bank_no" columnIndex="11"/>
		<result property="bankUser" column="bank_user" columnIndex="12"/>
		<result property="billNo" column="bill_no" columnIndex="13"/>
		<result property="billEnd" column="bill_end" columnIndex="14"/>
		<result property="memo" column="memo" columnIndex="15"/>
		<result property="deleYn" column="dele_yn" columnIndex="16"/>
		<result property="userDef1" column="user_def1" columnIndex="17"/>
		<result property="userDef2" column="user_def2" columnIndex="18"/>
		<result property="userDef3" column="user_def3" columnIndex="19"/>
		<result property="userDef4" column="user_def4" columnIndex="20"/>
		<result property="userDef5" column="user_def5" columnIndex="21"/>
		<result property="mdUser" column="md_user" columnIndex="22"/>
		<result property="mdDate" column="md_date" columnIndex="23"/>
		<result property="crUser" column="cr_user" columnIndex="24"/>
		<result property="crDate" column="cr_date" columnIndex="25"/>
	</resultMap>
	
	<insert id="SD0501DAO.insertSD0501">
		<selectKey resultClass="java.lang.String" keyProperty="receCode">
          <![CDATA[
            select lpad((coalesce(count(rece_code),0)+1)::varchar,4,'0') as rece_code 
				  	from openmps.mp_rece_info 
				  	where corp_code = #corpCode# 
					and rece_date = #receDate# 
          ]]>
      	</selectKey>
		<![CDATA[
			INSERT INTO openmps.mp_rece_info 
				( corp_code
				  , rece_date
				  , rece_code
				  , cust_code
				  , rece_amt
				  , rece_type
				  , team_code
				  , user_code
				  , bank_code
				  , bank_name
				  , bank_no
				  , bank_user
				  , bill_no
				  , bill_end
				  , memo
				  , dele_yn
				  , user_def1
				  , user_def2
				  , user_def3
				  , user_def4
				  , user_def5
				  , md_user
				  , md_date
				  , cr_user
				  , cr_date )
			VALUES ( #corpCode#
				  , #receDate#
				  , #receCode#
				  , #custCode#
				  , #receAmt#::numeric(11,0)
				  , #receType#
				  , #teamCode#
				  , #userCode#
				  , #bankCode#
				  , #bankName#
				  , #bankNo#
				  , #bankUser#
				  , #billNo#
				  , #billEnd#
				  , #memo#
				  , 'N'
				  , #userDef1#
				  , #userDef2#
				  , #userDef3#
				  , #userDef4#
				  , #userDef5#
				  , #mdUser#
				  , #mdDate#
				  , #crUser#
				  , now() )
		]]>
	</insert>
	
	<update id="SD0501DAO.updateSD0501">
		<![CDATA[
			UPDATE openmps.mp_rece_info
			SET rece_amt=#receAmt#::numeric(11,0)
				, rece_type=#receType#
				, team_code=#teamCode#
				, user_code=#userCode#
				, bank_code=#bankCode#
				, bank_name=#bankName#
				, bank_no=#bankNo#
				, bank_user=#bankUser#
				, bill_no=#billNo#
				, bill_end=#billEnd#
				, memo=#memo#
				, user_def1=#userDef1#
				, user_def2=#userDef2#
				, user_def3=#userDef3#
				, user_def4=#userDef4#
				, user_def5=#userDef5#
				, md_user=#mdUser#
				, md_date=now()
						WHERE corp_code=#corpCode#
								AND rece_date=#receDate#
								AND rece_code=#receCode#
				]]>
	</update>
	
	<delete id="SD0501DAO.deleteSD0501">
		<![CDATA[
			update openmps.mp_rece_info set dele_yn = 'Y'
						WHERE corp_code=#corpCode#
								AND rece_date=#receDate#
								AND rece_code=#receCode#
				]]>
	</delete>
	
	<select id="SD0501DAO.selectSD0501_S" resultMap="SD0501">
		<![CDATA[
			SELECT
				corp_code
				, rece_date
				, rece_code
				, cust_code
				, rece_amt
				, rece_type
				, team_code
				, user_code
				, bank_code
				, bank_name
				, bank_no
				, bank_user
				, bill_no
				, bill_end
				, memo
				, dele_yn
				, user_def1
				, user_def2
				, user_def3
				, user_def4
				, user_def5
				, md_user
				, md_date
				, cr_user
				, cr_date
			FROM openmps.mp_rece_info
			WHERE corp_code=#corpCode#
					AND rece_date=#receDate#
					AND rece_code=#receCode#
				]]>
	</select>
	<sql id="selectWhere_fragment">
	  	from openmps.mp_rece_info a
	  	left outer join mp_cust_info b on (a.corp_code = b.corp_code and a.cust_code = b.cust_code)
	  	left outer join tm_userxm d on (a.user_code = d.user_code)
	  	left outer join openmps.tm_teamxm team on (
						d.corp_code = team.corp_code 
						and d.team_code = team.team_code)
		left outer join openmps.tm_orguxm orgu on (
			team.corp_code = orgu.corp_code 
			and team.head_code = orgu.head_code)
	  	where 
	  	a.corp_code = #corpCode#
	  	and a.rece_date between #strtDate# and #lastDate#
		<dynamic >
			<isNotEmpty prepend="and" property="custCode">
			 a.cust_code = #custCode#
	        </isNotEmpty>
	        <isNotEmpty prepend="and" property="headCode">
			 orgu.head_code = #headCode#
	        </isNotEmpty> 
	        <isNotEmpty prepend="and" property="teamCode">
			 team.team_code = #teamCode#
	        </isNotEmpty> 
		</dynamic>
	</sql>
	<select id="SD0501DAO.selectSD0501List_D" parameterClass="SD0501SerarchVO" resultClass="egovMap">
		SELECT
				a.corp_code
				, a.rece_date
				, a.rece_code
				, a.cust_code
				, b.cust_name
				, b.owner
				, a.rece_amt
				, a.rece_type
				, openmps."FN_GET_TMCODEXDNM"(a.corp_code,'SD015',a.rece_type) as rece_typename
				, a.team_code
				, a.user_code
				, d.user_name as salesman_name
				, a.bank_code
				, a.bank_name
				, a.bank_no 
				, a.bank_user 
				, a.bill_no 
				, a.bill_end 
				, a.memo
		<include refid="selectWhere_fragment"/>
	</select>	
	<select id="SD0501DAO.selectSD0501ListTotCnt_S" parameterClass="SD0501SerarchVO" resultClass="int">
		select count(*)
		<include refid="selectWhere_fragment"/>
	</select>
	<!-- 
		수금 마감체크 
		수금월기준 rece_close < check
	 -->
	<select id="SD0501DAO.checkReceClosing" resultClass="int">
		<![CDATA[
		select count(*)
		from openmps.mp_closing_date
		where corp_code = #corpCode#
		and apply_month = substr(#receDate#,1,6)
		and rece_close < #receDate#
		limit 1
		]]>
	</select>
	
</sqlMap>
