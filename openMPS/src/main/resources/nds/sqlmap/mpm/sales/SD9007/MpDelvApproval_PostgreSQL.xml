<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="SD9007">
	
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="SD9007SerarchVO" type="nds.mpm.sales.SD0402.vo.SD0402VO"/>
	
	<!-- 
			SD9007 출고승인요청 접수 목록
			appro_request is not null
			당일미수 = o_cur_unpay
			전일미수 = o_pre_unpay
			여신한도 = o_cust_limit
			잔여한도 = o_remaining_limit
			결재상태 - appro_yn "Y" 출고승인, "X" 반려
			
			openmps."FN_GET_CUSTLIMIT"(
		    #corpCode#,
		    #custCode#,
		    #strtDate#,
		    #ordrAmt#,
		)
	-->
	<sql id="selectWhere_SD9007fragment">
		FROM openmps.mp_order_h ordrtb
		inner join openmps.mp_delv_approval da on (
				ordrtb.corp_code = da.corp_code 
				and ordrtb.delv_date = da.delv_date 
				and ordrtb.ordr_no = da.ordr_no
		)
		left outer join openmps."FN_GET_CUSTLIMIT"(
		    ordrtb.corp_code,
		    ordrtb.ordr_cust,
		    ordrtb.delv_date,
		    ordrtb.ordr_amt
		) custlimit on (1=1)
		left outer join openmps.mp_salesman_cust sc on ( 
			ordrtb.corp_code = sc.corp_code 
			and ordrtb.ordr_cust = sc.salesman_cust 
			)
		WHERE ordrtb.corp_code=#corpCode#
		and ordrtb.delv_date = #strtDate#
		<!-- 
		
		권한레벨에 맞는 결재대상목록 조회.
		대표 ceo salesmanLevel = 1
		부문장 head salesmanLevel = 2
		파트장 part salesmanLevel = 3
		-->
		
		<isEqual property="salesmanLevel" compareValue="1">
		and da.head_date is not null
		</isEqual>
		<isEqual property="salesmanLevel" compareValue="2">
		and da.part_date is not null
		</isEqual>
		<isEqual property="salesmanLevel" compareValue="3">
		and da.appro_request is not null
		</isEqual>
		<isNotEmpty property="salesman">
        and sc.salesman = #salesman#
        </isNotEmpty>
	</sql>
	<select id="SD9007DAO.selectSD9007List_D" parameterClass="SD0402SerarchVO" resultClass="egovMap">
		select
			ordrtb.ordr_no
			,ordrtb.ordr_cust
			,da.appro_request
			,o_cust_limit
			,ordrtb.ordr_amt
			,o_pre_unpay
			,o_remaining_limit
  			,da.appro_yn 
  			,da.appro_memo 
  			,da.part_code 
  			,da.part_appro 
  			,da.part_date 
  			,da.head_code 
  			,da.head_appro 
  			,da.head_date 
  			,da.ceo_appro 
  			,da.ceo_date 
		<include refid="selectWhere_SD9007fragment"/>
	</select>
	<select id="SD9007DAO.selectSD9007ListTotCnt_S" parameterClass="SD0402SerarchVO" resultClass="int">
		select count(*)
		<include refid="selectWhere_SD9007fragment"/>
	</select>
	<!-- 출고이력 최근 10건  -->
	<select id="SD9007DAO.selectSD9007HistList" parameterClass="SD0402SerarchVO" resultClass="egovMap">
		select
			da.delv_date
			,da.ordr_amt
			,(o_remaining_limit - da.ordr_amt) as over_amt
  			,da.appro_yn 
  		from openmps.mp_delv_approval da
  		left outer join openmps."FN_GET_CUSTLIMIT"(
		    #corpCode#,
		   	#ordrCust#,
		    da.delv_date,
		    da.ordr_amt
		) custlimit on (1=1)
  		where a.corp_code=#corpCode#
		and a.ordr_no = #ordrNo#
		and exists ( select '1' from openmps.mp_order_h where corp_code=#corpCode# 
						and delv_date = da.delv_date and ordr_no = da.ordr_no)
		order by delv_date desc
		limit 10
	</select>
</sqlMap>
