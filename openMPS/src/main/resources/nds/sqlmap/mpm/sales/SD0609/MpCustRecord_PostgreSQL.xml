<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="SD0609MpCustRecord">
	
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="SD0609mpCustRecordSerarchVO" type="nds.mpm.sales.SD0604.vo.MpCustRecordVO"/>
	
	<sql id="select_CustRecordListBody">
		WITH t1 
               AS ( select c.corp_code, "FN_GET_TMCODEXDNM" (c.corp_code, 'SD024', c.sale_group1) etc1_name,
                                     "FN_GET_TMCODEXDNM" (c.corp_code, 'SD025', c.sale_group2) sale_group1_name
                                             ,sale_group2
                                             ,c.pro_code
                                             ,c.pro_name
                                  ,sum(c.sale_box) sale_box
                                             ,sum(c.sale_weight) sale_weight
                                  ,sum(case when c.sale_box = 0 then 0 else trunc((c.sale_amt + c.sale_vat)/c.sale_box) end) avg_price
                                             ,sum(c.sale_amt + c.sale_vat) sale_amt
                              from (select a.corp_code
                                             ,b.sale_box
                                          ,b.sale_weight
                                          ,b.sale_amt
                                          ,b.sale_vat
                                          ,a.part_code
                                          ,b.sale_date
                                          ,h.pro_code
                                          ,h.pro_name
                                          ,h.sale_group1
                                          ,h.sale_group2
                                      from mp_cust_hist a
                                          ,mp_cust_record b
                                          ,mp_cust_info e
                                          ,mp_item_master_m h
                                     where a.corp_code = #corpCode#
                                       and a.part_code = #teamCode#
                                       and to_char(now(), 'YYYYMMDD')::varchar between a.start_date and a.last_date
                                       and b.sale_date between #strtDate# and #lastDate#
                                       and a.corp_code = b.corp_code
                                       and a.cust_code = b.cust_code
                                       and a.corp_code = e.corp_code
                                       and a.cust_code = e.cust_code
                                                    and b.corp_code = h.corp_code
                                       and b.pro_code  = h.pro_code) c
                            group by c.corp_code, c.sale_group1, c.sale_group2, c.pro_code, c.pro_name 
                            order by c.sale_group2, c.pro_name
                    
                    ),
               goal 
               AS (     select h.sale_group2, h.pro_code
                                          ,sum(b.target_weight) target_weight
                                      from mp_cust_hist a
                                          ,mp_target_yymm b
                                          ,mp_cust_info e
                                          ,mp_item_master_m h
                                     where a.corp_code = #corpCode#
                                       and a.part_code = #teamCode#
                                       and to_char(now(), 'YYYYMMDD')::varchar between a.start_date and a.last_date
                                       and b.target_yymm = substr(#strtDate#, 1, 6)
                                       and a.corp_code = b.corp_code
                                       and a.part_code = b.part_code
                                       and a.corp_code = e.corp_code
                                       and a.cust_code = e.cust_code
                                                    and b.corp_code = h.corp_code
                                       and b.sale_group2  = h.sale_group2
                                    group by h.sale_group2, h.pro_code
               
                     ),
               t3 
               AS (  select h.sale_group2, h.pro_code
                                          ,sum(b.sale_weight) psale_weight
                                      from mp_cust_hist a
                                          ,mp_cust_record b
                                          ,mp_cust_info e
                                          ,mp_item_master_m h
                                     where a.corp_code = #corpCode#
                                       and a.part_code = #teamCode#
                                       and to_char(now(), 'YYYYMMDD')::varchar between a.start_date and a.last_date
                                       and b.sale_date between TO_CHAR(TO_DATE(#strtDate#, 'yyyymmdd') - INTERVAL '1 MONTH', 'YYYYMMDD')
                                                                    AND openmps."FN_GET_LASTDAY" (#lastDate#, 'm')
                                       and a.corp_code = b.corp_code
                                       and a.cust_code = b.cust_code
                                       and a.corp_code = e.corp_code
                                       and a.cust_code = e.cust_code
                                                    and b.corp_code = h.corp_code
                                       and b.pro_code  = h.pro_code
                                    group by h.sale_group2, h.pro_code   
                   ORDER BY 1),
               t4 
               AS (  select h.sale_group2, h.pro_code
                                          ,sum(b.sale_weight) pyyyy_weight
                                      from mp_cust_hist a
                                          ,mp_cust_record b
                                          ,mp_cust_info e
                                          ,mp_item_master_m h
                                     where a.corp_code = #corpCode#
                                       and a.part_code = #teamCode#
                                       and to_char(now(), 'YYYYMMDD')::varchar between a.start_date and a.last_date
                                       and b.sale_date between TO_CHAR(TO_DATE(#strtDate#, 'yyyymmdd') - INTERVAL '12 MONTH', 'YYYYMMDD')
                                                                    AND openmps."FN_GET_LASTDAY" (#lastDate#, 'y')
                                       and a.corp_code = b.corp_code
                                       and a.cust_code = b.cust_code
                                       and a.corp_code = e.corp_code
                                       and a.cust_code = e.cust_code
                                                    and b.corp_code = h.corp_code
                                       and b.pro_code  = h.pro_code
                                    group by h.sale_group2, h.pro_code 
                   ORDER BY 1)
            SELECT t1.etc1_name,
                         t1.sale_group1_name,
                         t1.sale_group2,
                         t1.pro_code,
                   t1.pro_name,
                   t1.sale_box,
                   t1.sale_weight,
                   t1.avg_price,
                   t1.sale_amt,
                   goal.target_weight,
                   case when goal.target_weight = 0 then 0 else trunc(t1.sale_weight/goal.target_weight*100) end target_rate,
                   t3.psale_weight,
                   
                   t1.sale_weight-t3.psale_weight reduce_weight,
                   t4.pyyyy_weight,
                   t1.sale_weight-t4.pyyyy_weight yreduce_weight
              FROM t1
                   LEFT OUTER JOIN goal ON t1.pro_code = goal.pro_code and t1.sale_group2 = goal.sale_group2
                   LEFT OUTER JOIN t3 ON t1.pro_code = t3.pro_code and t1.sale_group2 = t3.sale_group2
                   LEFT OUTER JOIN t4 ON t1.pro_code = t4.pro_code and t1.sale_group2 = t4.sale_group2
              <isEqual property="searchCondition" compareValue="mark">
                   inner join mp_salesman_pro pro
                           on pro.corp_code = t1.corp_code
                           and pro.salesman like #userCode#
                           and pro.salesman_prod = t1.pro_code
              </isEqual>
          ORDER BY 1, 3, 4
	</sql>
	
	<select id="SD0609mpCustRecordDAO.selectMpCustRecordList_D" parameterClass="SD0609mpCustRecordSerarchVO" resultClass="egovMap">
		SELECT  a.*
		FROM(
			<include refid="select_CustRecordListBody"/>
		) a
		order by 1, 2, 3
	</select>	
	
	<select id="SD0609mpCustRecordDAO.selectMpCustRecordListTotCnt_S" parameterClass="SD0609mpCustRecordSerarchVO" resultClass="int">
		SELECT
				count(a.*)
		FROM(
			<include refid="select_CustRecordListBody"/>
		) a	
	</select>
	
	<sql id="select_DetailTab1Body">
		WITH t1 
               AS ( select c.corp_code, o.head_name, g.dept_name, c.part_code, c.pro_code, u.user_code, u.user_name salesman
                                  ,sum(c.sale_box) sale_box
                                             ,sum(c.sale_weight) sale_weight
                                  ,sum(case when c.sale_box = 0 then 0 else trunc((c.sale_amt + c.sale_vat)/c.sale_box) end) avg_price
                                             ,sum(c.sale_amt + c.sale_vat) sale_amt
                              from (select a.corp_code
                                              ,b.head_cust
                                              ,h.pro_code
                                          ,a.salesman
                                             ,b.sale_box
                                          ,b.sale_weight
                                          ,b.sale_amt
                                          ,b.sale_vat
                                          ,a.part_code
                                          ,b.sale_date
                                      from mp_cust_hist a
                                          ,mp_cust_record b
                                          ,mp_cust_info e
                                          ,mp_item_master_m h
                                     where a.corp_code = #corpCode#
                                       and a.part_code = #teamCode#
                                       and h.pro_code = #proCode#
                                       and to_char(now(), 'YYYYMMDD')::varchar between a.start_date and a.last_date
                                       and b.sale_date between #strtDate# and #lastDate#
                                       and a.corp_code = b.corp_code
                                       and a.cust_code = b.cust_code
                                       and a.corp_code = e.corp_code
                                       and a.cust_code = e.cust_code
                                                    and b.corp_code = h.corp_code
                                       and b.pro_code  = h.pro_code) c
                                       ,tm_deptxm g
                                           ,tm_orguxm o
                                           ,tm_userxm u
                                     where c.corp_code = g.corp_code
                                       and c.part_code = g.dept_code
                                       and g.corp_code = o.corp_code
                                       AND g.head_code = o.head_code
                                       and c.salesman = u.user_code
                            group by c.corp_code, o.head_name, g.dept_name, c.part_code, c.pro_code, u.user_code, u.user_name
                            order by u.user_name
                    
                    ),
               goal 
               AS (     select b.salesman
                                          ,sum(b.target_weight) target_weight
                                      from mp_cust_hist a
                                          ,mp_target_yymm b
                                          ,mp_cust_info e
                                          ,mp_item_master_m h
                                     where a.corp_code = #corpCode#
                                       and a.part_code = #teamCode#
                                       and h.pro_code = #proCode#
                                       and to_char(now(), 'YYYYMMDD')::varchar between a.start_date and a.last_date
                                       and b.target_yymm = substr(#strtDate#, 1, 6)
                                       and a.corp_code = b.corp_code
                                       and a.part_code = b.part_code
                                       and a.corp_code = e.corp_code
                                       and a.cust_code = e.cust_code
                                                    and b.corp_code = h.corp_code
                                       and b.sale_group2  = h.sale_group2
                                    group by b.salesman
               
                     ),
               t3 
               AS (  select a.salesman
                                          ,sum(b.sale_weight) psale_weight
                                      from mp_cust_hist a
                                          ,mp_cust_record b
                                          ,mp_cust_info e
                                          ,mp_item_master_m h
                                     where a.corp_code = #corpCode#
                                       and a.part_code = #teamCode#
                                       and h.pro_code = #proCode#
                                       and to_char(now(), 'YYYYMMDD')::varchar between a.start_date and a.last_date
                                       and b.sale_date between TO_CHAR(TO_DATE(#strtDate#, 'yyyymmdd') - INTERVAL '1 MONTH', 'YYYYMMDD')
                                                                    AND openmps."FN_GET_LASTDAY" (#lastDate#, 'm')
                                       and a.corp_code = b.corp_code
                                       and a.cust_code = b.cust_code
                                       and a.corp_code = e.corp_code
                                       and a.cust_code = e.cust_code
                                                    and b.corp_code = h.corp_code
                                       and b.pro_code  = h.pro_code
                                    group by a.salesman 
                   ORDER BY 1),
               t4 
               AS (  select a.salesman
                                          ,sum(b.sale_weight) pyyyy_weight
                                      from mp_cust_hist a
                                          ,mp_cust_record b
                                          ,mp_cust_info e
                                          ,mp_item_master_m h
                                     where a.corp_code = #corpCode#
                                       and a.part_code = #teamCode#
                                       and h.pro_code = #proCode#
                                       and to_char(now(), 'YYYYMMDD')::varchar between a.start_date and a.last_date
                                       and b.sale_date between TO_CHAR(TO_DATE(#strtDate#, 'yyyymmdd') - INTERVAL '12 MONTH', 'YYYYMMDD')
                                                                    AND openmps."FN_GET_LASTDAY" (#lastDate#, 'y')
                                       and a.corp_code = b.corp_code
                                       and a.cust_code = b.cust_code
                                       and a.corp_code = e.corp_code
                                       and a.cust_code = e.cust_code
                                                    and b.corp_code = h.corp_code
                                       and b.pro_code  = h.pro_code
                                    group by a.salesman
                   ORDER BY 1)
            SELECT t1.corp_code,
                         t1.head_name, 
                         t1.dept_name team_name, 
                         t1.part_code,
                         t1.pro_code, 
                         t1.salesman, 
                         t1.user_code,
                         t1.sale_box,
                   t1.sale_weight,
                   t1.avg_price,
                   t1.sale_amt,
                   goal.target_weight,
                   case when goal.target_weight = 0 then 0 else trunc(t1.sale_weight/goal.target_weight*100) end target_rate,
                   t3.psale_weight,
                   t1.sale_weight-t3.psale_weight reduce_weight,
                   t4.pyyyy_weight,
                   t1.sale_weight-t4.pyyyy_weight yreduce_weight
              FROM t1
                       LEFT OUTER JOIN goal ON t1.user_code = goal.salesman
                   LEFT OUTER JOIN t3 ON t1.user_code = t3.salesman
                   LEFT OUTER JOIN t4 ON t1.user_code = t4.salesman
              <isEqual property="searchCondition" compareValue="mark">
                   inner join mp_salesman_pro pro
                           on pro.corp_code = t1.corp_code
                           and pro.salesman like #userCode#
                           and t1.pro_code = pro.salesman_prod
              </isEqual>
          ORDER BY 1, 3, 4
	</sql>
	
	<select id="SD0609mpCustRecordDAO.selectDetailTab1MpCustRecordList_D" parameterClass="SD0609mpCustRecordSerarchVO" resultClass="egovMap">
		SELECT    a.*
		FROM(
				<include refid="select_DetailTab1Body"/>
		) a
		order by 1, 2, 3
	</select>	
	
	<sql id="select_DetailTab2Body">
		WITH t1 
               AS ( select c.corp_code, o.head_name, g.dept_name, c.part_code, c.dist_type, c.pro_code
                                              ,openmps."FN_GET_TMCODEXDNM" (c.corp_code, 'SD005', c.dist_type) dist_typenm
                                        ,sum(c.sale_box) sale_box
                                             ,sum(c.sale_weight) sale_weight
                                  ,sum(case when c.sale_box = 0 then 0 else trunc((c.sale_amt + c.sale_vat)/c.sale_box) end) avg_price
                                             ,sum(c.sale_amt + c.sale_vat) sale_amt
                              from (select a.corp_code
                                              ,b.head_cust
                                          ,e.dist_type
                                          ,h.pro_code
                                             ,b.sale_box
                                          ,b.sale_weight
                                          ,b.sale_amt
                                          ,b.sale_vat
                                          ,a.part_code
                                          ,b.sale_date
                                      from mp_cust_hist a
                                          ,mp_cust_record b
                                          ,mp_cust_info e
                                          ,mp_item_master_m h
                                     where a.corp_code = #corpCode#
                                       and a.part_code = #teamCode#
                                       and h.pro_code = #proCode#
                                       and to_char(now(), 'YYYYMMDD')::varchar between a.start_date and a.last_date
                                       and b.sale_date between #strtDate# and #lastDate#
                                       and a.corp_code = b.corp_code
                                       and a.cust_code = b.cust_code
                                       and a.corp_code = e.corp_code
                                       and a.cust_code = e.cust_code
                                                    and b.corp_code = h.corp_code
                                       and b.pro_code  = h.pro_code) c
                                       ,tm_deptxm g
                                           ,tm_orguxm o
                                     where c.corp_code = g.corp_code
                                       and c.part_code = g.dept_code
                                       and g.corp_code = o.corp_code
                                       AND g.head_code = o.head_code
                            group by c.corp_code, o.head_name, g.dept_name, c.part_code, c.dist_type, c.pro_code
                            order by 1, 2, 4
                    ),
               goal 
               AS (     select e.dist_type
                                          ,sum(b.target_weight) target_weight
                                      from mp_cust_hist a
                                          ,mp_target_yymm b
                                          ,mp_cust_info e
                                          ,mp_item_master_m h
                                     where a.corp_code = #corpCode#
                                       and a.part_code = #teamCode#
                                       and h.pro_code = #proCode#
                                       and to_char(now(), 'YYYYMMDD')::varchar between a.start_date and a.last_date
                                       and b.target_yymm = substr(#strtDate#, 1, 6)
                                       and a.corp_code = b.corp_code
                                       and a.part_code = b.part_code
                                       and a.corp_code = e.corp_code
                                       and a.cust_code = e.cust_code
                                                    and b.corp_code = h.corp_code
                                       and b.sale_group2  = h.sale_group2
                                    group by e.dist_type
               
                     ),
               t3 
               AS (  select e.dist_type
                                          ,sum(b.sale_weight) psale_weight
                                      from mp_cust_hist a
                                          ,mp_cust_record b
                                          ,mp_cust_info e
                                          ,mp_item_master_m h
                                     where a.corp_code = #corpCode#
                                       and a.part_code = #teamCode#
                                       and h.pro_code = #proCode#
                                       and to_char(now(), 'YYYYMMDD')::varchar between a.start_date and a.last_date
                                       and b.sale_date between TO_CHAR(TO_DATE(#strtDate#, 'yyyymmdd') - INTERVAL '1 MONTH', 'YYYYMMDD')
                                                                    AND openmps."FN_GET_LASTDAY" (#lastDate#, 'm')
                                       and a.corp_code = b.corp_code
                                       and a.cust_code = b.cust_code
                                       and a.corp_code = e.corp_code
                                       and a.cust_code = e.cust_code
                                                    and b.corp_code = h.corp_code
                                       and b.pro_code  = h.pro_code
                                    group by e.dist_type
                   ORDER BY 1),
               t4 
               AS (  select e.dist_type
                                          ,sum(b.sale_weight) pyyyy_weight
                                      from mp_cust_hist a
                                          ,mp_cust_record b
                                          ,mp_cust_info e
                                          ,mp_item_master_m h
                                     where a.corp_code = #corpCode#
                                       and a.part_code = #teamCode#
                                       and h.pro_code = #proCode#
                                       and to_char(now(), 'YYYYMMDD')::varchar between a.start_date and a.last_date
                                       and b.sale_date between TO_CHAR(TO_DATE(#strtDate#, 'yyyymmdd') - INTERVAL '12 MONTH', 'YYYYMMDD')
                                                                    AND openmps."FN_GET_LASTDAY" (#lastDate#, 'y')
                                       and a.corp_code = b.corp_code
                                       and a.cust_code = b.cust_code
                                       and a.corp_code = e.corp_code
                                       and a.cust_code = e.cust_code
                                                    and b.corp_code = h.corp_code
                                       and b.pro_code  = h.pro_code
                                    group by e.dist_type
                   ORDER BY 1)
            SELECT t1.corp_code,
                         t1.head_name, 
                         t1.dept_name team_name, 
                         t1.part_code, 
                         t1.dist_type dist_code,
                         t1.dist_typenm dist_type,
                         t1.sale_box,
                   t1.sale_weight,
                   t1.avg_price,
                   t1.sale_amt,
                   goal.target_weight,
                   case when goal.target_weight = 0 then 0 else trunc(t1.sale_weight/goal.target_weight*100) end target_rate,
                   t3.psale_weight,
                   t1.sale_weight-t3.psale_weight reduce_weight,
                   t4.pyyyy_weight,
                   t1.sale_weight-t4.pyyyy_weight yreduce_weight
              FROM t1
                       LEFT OUTER JOIN goal ON t1.dist_type = goal.dist_type
                   LEFT OUTER JOIN t3 ON t1.dist_type = t3.dist_type
                   LEFT OUTER JOIN t4 ON t1.dist_type = t4.dist_type
              <isEqual property="searchCondition" compareValue="mark">
                   inner join mp_salesman_pro pro
                           on pro.corp_code = t1.corp_code
                           and pro.salesman like #userCode#
                           and t1.pro_code = pro.salesman_prod
              </isEqual>
          ORDER BY 1, 3, 4
	</sql>
	
	<select id="SD0609mpCustRecordDAO.selectDetailTab2MpCustRecordList_D" parameterClass="SD0609mpCustRecordSerarchVO" resultClass="egovMap">
		SELECT    a.*
		FROM(
				<include refid="select_DetailTab2Body"/>
		) a
		order by 1, 2, 3
	</select>
</sqlMap>
