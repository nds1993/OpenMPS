<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="SD0610MpCustRecord">
	
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	
	<select id="SD0610mpCustRecordDAO.selectMpCustRecordList_H" resultClass="egovMap">
		with cust_record as (
			select record.corp_code, sale_date, cust_code, pro_code, sale_box, sale_weight, sale_amt, sale_vat
			from	(	select corp_code, sale_date, cust_code, pro_code, sale_box, sale_weight, sale_amt, sale_vat
						from	mp_cust_record
						where corp_code = #corpCode#
						and	sale_date between #strtDate# and #lastDate#
						union
						select corp_code, sale_date, cust_code, pro_code, sale_box, sale_weight, sale_amt, sale_vat
						from	mp_cust_record
						where corp_code = #corpCode#
						and	sale_date between to_char( date(#strtDate#) - interval '1 months','yyyymmdd') and to_char( date(#lastDate#) - interval '1 months','yyyymmdd')
						union
						select corp_code, sale_date, cust_code, pro_code, sale_box, sale_weight, sale_amt, sale_vat
						from	mp_cust_record
						where corp_code = #corpCode#
						and	sale_date between to_char( date(#strtDate#) - interval '12 months','yyyymmdd') and to_char( date(#lastDate#) - interval '12 months','yyyymmdd') ) record
						left outer join mp_salesman_pro pro
							on pro.corp_code = #corpCode#
							and pro.salesman like #salesman#
							and coalesce(interest_pro,0) > 0
							and record.pro_code = pro.salesman_prod
				where	coalesce(pro.interest_pro,0) >= case when #interest# = 'Y' then 1 else 0 end
		)
		, hist as (
			select corp_code, cust_code, seq_no, start_date, last_date, part_code, salesman
			from	mp_cust_hist
			where	corp_code = #corpCode#
			and	part_code like #teamCode#
		)
		, record0 as (
			select cust_record.*, hist.part_code, salesman, hist.start_date, hist.last_date
			from	cust_record
					inner join hist
						on cust_record.cust_code = hist.cust_code
						and cust_record.sale_date between hist.start_date and hist.last_date
		)
		, item as (
			select corp_code, pro_code as item_code, pro_name as item_name
					,coalesce(sale_group1,'10') sale_group1, coalesce((select code_name from tm_codexd where group_code = 'SD024' and code_id = sale_group1),'기타') sale_name1
					,coalesce(sale_group2,'0') sale_group2,  coalesce((select code_name from tm_codexd where group_code = 'SD025' and code_id = sale_group2),'기타') sale_name2
			from	mp_item_master_m
			where	corp_code = #corpCode#
		)
		, record1 as (
			select sale_group1, sale_name1, item.sale_group2, sale_name2, pro_code, item_name
					,sum(sale_box) sale_box
					,sum(sale_weight) sale_weight
					,case when sum(sale_weight) != 0 then round(sum(sale_amt+sale_vat) / sum(sale_weight),0)
							else sum(sale_amt+sale_vat) end avg_amt
					,sum(sale_amt+sale_vat) sale_amt
			from	record0
					left outer join item
						on record0.pro_code = item.item_code
			where	record0.sale_date between #strtDate# and #lastDate#
			group by sale_group1, sale_name1, item.sale_group2, sale_name2, pro_code, item_name
		)
		, record2 as (
			select pro_code, sum(sale_weight) sale_weight2
					,round(sum(sale_weight) / (to_date(#lastDate#, 'yyyymmdd')-to_date(#strtDate#, 'yyyymmdd')+1),1) as avg_weight2
			from	record0
			where	record0.sale_date between to_char( date(#strtDate#) - interval '1 months','yyyymmdd') and to_char( date(#lastDate#) - interval '1 months','yyyymmdd')
			group by pro_code
		)
		, record3 as (
			select pro_code, sum(sale_weight) sale_weight3
			from	record0
			where	record0.sale_date between to_char( date(#strtDate#) - interval '12 months','yyyymmdd') and to_char( date(#lastDate#) - interval '12 months','yyyymmdd')
			group by pro_code
		)
		, goal as (
			select corp_code, sale_group2
					,sum(target_weight) target_weight
			from	mp_custgoal_yymm
			where	corp_code = #corpCode#
			and	target_yymm between substr(#strtDate#,1,6) and substr(#lastDate#,1,6)
			group by corp_code, sale_group2
		)
		select sale_group1, sale_name1, record1.sale_group2, sale_name2
				,record1.pro_code, record1.item_name
				,coalesce(sale_box,0) sale_box, coalesce(sale_weight,0.0) sale_weight
				,coalesce(avg_amt,0) avg_amt, coalesce(sale_amt,0) sale_amt, coalesce(target_weight,0.0) target_weight
				,coalesce(round((sale_weight / target_weight * 100),2),0.0) as sale_rate
				,coalesce(sale_weight2,0.0) sale_weight2, coalesce((sale_weight2 - sale_weight),0.0) as inc_weight2
				,coalesce(sale_weight3,0.0) sale_weight3, coalesce((sale_weight3 - sale_weight),0.0) as inc_weight3
		from	record1
				left outer join record2
					on record1.pro_code = record2.pro_code
				left outer join record3
					on record1.pro_code = record3.pro_code
				left outer join goal
					on record1.sale_group2 = goal.sale_group2
		order by sale_group1, sale_group2, record1.pro_code
	</select>
	
	<select id="SD0610mpCustRecordDAO.selectMpCustRecordList_D" resultClass="egovMap">
		with cust_record as (
			select record.corp_code, sale_date, cust_code, pro_code, sale_box, sale_weight, sale_amt, sale_vat
			from	(	select corp_code, sale_date, cust_code, pro_code, sale_box, sale_weight, sale_amt, sale_vat
						from	mp_cust_record
						where corp_code = #corpCode#
						and	sale_date between #strtDate# and #lastDate#
						union
						select corp_code, sale_date, cust_code, pro_code, sale_box, sale_weight, sale_amt, sale_vat
						from	mp_cust_record
						where corp_code = #corpCode#
						and	sale_date between to_char( date(#strtDate#) - interval '1 months','yyyymmdd') and to_char( date(#lastDate#) - interval '1 months','yyyymmdd')
						union
						select corp_code, sale_date, cust_code, pro_code, sale_box, sale_weight, sale_amt, sale_vat
						from	mp_cust_record
						where corp_code = #corpCode#
						and	sale_date between to_char( date(#strtDate#) - interval '12 months','yyyymmdd') and to_char( date(#lastDate#) - interval '12 months','yyyymmdd') ) record
			where pro_code = #proCode#
		)
		, hist as (
			select corp_code, cust_code, seq_no, start_date, last_date, part_code, salesman
			from	mp_cust_hist
			where	corp_code = #corpCode#
			and	part_code like #teamCode#
		)
		, record0 as (
			select cust_record.*, hist.part_code, salesman, hist.start_date, hist.last_date
			from	cust_record
					inner join hist
						on cust_record.cust_code = hist.cust_code
						and cust_record.sale_date between hist.start_date and hist.last_date
		)
		, cust as (
			select corp_code, cust_code, cust_name, short_name, dist_type
					,(select code_name from tm_codexd where group_code = 'SD005' and code_id = dist_type) dist_name
			from	mp_cust_info
			where	corp_code = #corpCode#
		)
		, record1 as (
			select salesman, user_name, record0.cust_code, cust_name
					,sum(sale_box) sale_box
					,sum(sale_weight) sale_weight
					,case when sum(sale_weight) != 0 then round(sum(sale_amt+sale_vat) / sum(sale_weight),0)
							else sum(sale_amt+sale_vat) end avg_amt
					,sum(sale_amt+sale_vat) sale_amt
			from	record0
					left outer join cust
						on record0.cust_code = cust.cust_code
					left outer join tm_userxm
						on tm_userxm.corp_code = #corpCode#
						and record0.salesman = user_code
			where	record0.sale_date between #strtDate# and #lastDate#
			group by salesman, user_name, record0.cust_code, cust_name
		)
		, record2 as (
			select cust_code, sum(sale_weight) sale_weight2
					,round(sum(sale_weight) / (to_date(#lastDate#, 'yyyymmdd')-to_date(#strtDate#, 'yyyymmdd')+1),1) as avg_weight2
			from	record0
			where	record0.sale_date between to_char( date(#strtDate#) - interval '1 months','yyyymmdd') and to_char( date(#lastDate#) - interval '1 months','yyyymmdd')
			group by cust_code
		)
		, record3 as (
			select cust_code, sum(sale_weight) sale_weight3
			from	record0
			where	record0.sale_date between to_char( date(#strtDate#) - interval '12 months','yyyymmdd') and to_char( date(#lastDate#) - interval '12 months','yyyymmdd')
			group by cust_code
		)
		, goal as (
			select corp_code, cust_code
					,sum(target_weight) target_weight
			from	mp_custgoal_yymm
			where	corp_code = #corpCode#
			and	target_yymm between substr(#strtDate#,1,6) and substr(#lastDate#,1,6)
			group by corp_code, cust_code
		)
		select salesman, user_name, record1.cust_code, cust_name 
				,sale_box, sale_weight, avg_amt, sale_amt, target_weight
				,round((sale_weight / target_weight * 100),2) as sale_rate
				,sale_weight2, (sale_weight2 - sale_weight) as inc_weight2
				,sale_weight3, (sale_weight3 - sale_weight) as inc_weight3
		from	record1
				left outer join record2
					on record1.cust_code = record2.cust_code
				left outer join record3
					on record1.cust_code = record3.cust_code
				left outer join goal
					on record1.cust_code = goal.cust_code
		order by user_name, record1.cust_code
	</select>
		
	<select id="SD0610mpCustRecordDAO.selectMpCustRecordListTotCnt_S" resultClass="egovMap">
		
	</select>
	
</sqlMap>
