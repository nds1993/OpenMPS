<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="SD0803MpOrderD">
	
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="SD0803MpOrderHSerarchVO" type="nds.mpm.sales.SD0405.vo.MpOrderHVO"/>
	<!-- 
		
		전표유형 매출의 회송전표생성.
	
	  -->
	<insert id="SD0803MpOrderDDAO.insertReturnMpOrderH">
		<selectKey keyProperty="ordrCust" resultClass="string">
		    select #ordrCust# as ordr_cust
		</selectKey>
			insert into openmps.mp_order_h
			select 
				corp_code, #returnDelvDate#, #returnOrdrNo#, '50', ordr_cust, delv_cust, 
		       sale_cust, aggre_gubn, delv_type, delv_dc, amt_display, limit_yn, 
		       occur_src, appro_yn
		       , (coalesce(ordr_weight,0) * -1) as ordr_weight
		       , (coalesce(ordr_amt,0) * -1) as ordr_amt
		       , delv_weight
		       , delv_amt, 
		       phone_no, arrival_time, #memo#, status, if_status, cr_user, cr_date, 
		    md_user, md_date
		    from openmps.mp_order_h
		    where corp_code = #corpCode#
		    and delv_date = #delvDate#
		    and ordr_no = #ordrNo#
		    and ordr_cust = #ordrCust#
	</insert>
	<insert id="SD0803MpOrderDDAO.insertReturnMpOrderD">
		<selectKey keyProperty="ordrCust" resultClass="string">
		    select #ordrCust# as ordr_cust
		</selectKey>
			insert into openmps.mp_order_d
			select corp_code, #returnDelvDate#, #returnOrdrNo#, ordr_seq, pro_code, sale_group2, 
			       pro_ukind, price_src
			       , unit_price
			       , ordr_box
			       , (coalesce(ordr_weight,0) * -1) as ordr_weight
			       , (coalesce(ordr_amt,0) * -1) as ordr_amt
			       , (coalesce(ordr_vat,0) * -1) as ordr_vat
			       , delv_box, delv_weight, delv_amt, delv_vat, weight_comp, 
			       pm_accept_yn, status, if_status, cust_po_no, cust_po_seq, cust_pro_code, 
			       cr_user, cr_date, md_user, md_date
			from mp_order_d
			where corp_code = #corpCode#
		    and delv_date = #delvDate#
		    and ordr_no = #ordrNo#
		    <isNotEmpty property="proCodes">	
				<iterate prepend="and pro_code in" property="proCodes" open="(" close=")" conjunction="," >
	             #proCodes[]#
	            </iterate>	
            </isNotEmpty>
	</insert>
	
	<!-- 
		
		전표유형 매출의 매출전표생성.
	
	  -->
	<insert id="SD0803MpOrderDDAO.insertReCreateMpOrderD">
		<selectKey keyProperty="ordrCust" resultClass="string">
		    select #ordrCust# as ordr_cust
		</selectKey>
			insert into openmps.mp_order_d
			select 
				corp_code
				, delv_date
				, ordr_no
				, ordr_seq, pro_code, sale_group2
				, pro_ukind, price_src
			    , cur_price as unit_price
			    , ordr_box
			    , ordr_weight
			    , (ordr_box * cur_price) as ordr_amt
			    , ordr_vat
			    , delv_box, delv_weight, delv_amt, delv_vat, weight_comp
			    , pm_accept_yn, status, if_status, cust_po_no, cust_po_seq, cust_pro_code
			    , cr_user, cr_date, md_user, md_date
			from
			( 
				select
				corp_code, #newDelvDate# as delv_date, #newOrdrNo# ordr_no, ordr_seq, pro_code, sale_group2, 
			       pro_ukind, price_src
			       , unit_price
			       , ordr_box
			       , coalesce(ordr_weight,0) as ordr_weight
			       , coalesce(ordr_amt,0) as ordr_amt
			       , coalesce(ordr_vat,0) as ordr_vat
			       , delv_box, delv_weight, delv_amt, delv_vat, weight_comp, 
			       pm_accept_yn, status, if_status, cust_po_no, cust_po_seq, cust_pro_code, 
			       cr_user, cr_date, md_user, md_date
			       ,openmps."FN_GET_PROPRICE"(corp_code, #newDelvDate#, #ordrCust#, pro_code) cur_price
				from openmps.mp_order_d
				where corp_code = #corpCode#
			    and delv_date = #delvDate#
			    and ordr_no = #ordrNo#
			    <isNotEmpty property="proCodes">	
					<iterate prepend="and pro_code in" property="proCodes" open="(" close=")" conjunction="," >
		             #proCodes[]#
		            </iterate>	
	            </isNotEmpty>
			)
			tt
	</insert>
	<insert id="SD0803MpOrderDDAO.insertReCreateMpOrderH">
		<selectKey keyProperty="ordrCust" resultClass="string">
		    select #ordrCust# as ordr_cust
		</selectKey>
			insert into openmps.mp_order_h
			select 
				corp_code, delv_date, ordr_no, ordr_type, ordr_cust, delv_cust, 
		       sale_cust, aggre_gubn, delv_type, delv_dc, amt_display, limit_yn, 
		       occur_src, appro_yn
		       , ordr_weight
		       , ordr_amt
		       , delv_weight
		       , delv_amt, 
		       phone_no, arrival_time, #memo#, status, if_status, cr_user, cr_date, 
		    md_user, md_date
		    from 
		    (
		    	select
		    		max(h.corp_code) as corp_code
		    		, #newDelvDate# as delv_date
		    		, #newOrdrNo# as ordr_no
		    		, max(h.ordr_type) as ordr_type
		    		, max(h.ordr_cust) as ordr_cust
		    		, max(h.delv_cust) as delv_cust
		    		, max(h.sale_cust) as sale_cust
		    		, max(h.aggre_gubn) as aggre_gubn
		    		, max(h.delv_type) as delv_type
		    		, max(h.delv_dc) as delv_dc
		    		, max(h.amt_display) as amt_display
		    		, max(h.limit_yn) as limit_yn
		    		, max(h.occur_src) as occur_src
		    		, max(h.appro_yn) as appro_yn
				    , sum(coalesce(d.ordr_weight,0)) as ordr_weight
				    , sum(coalesce(d.ordr_amt,0)) + sum(coalesce(d.ordr_vat,0)) as ordr_amt
				    , max(h.delv_weight) as delv_weight
				    , max(h.delv_amt) as delv_amt
				    , max(h.phone_no) as phone_no
				    , max(h.arrival_time) as arrival_time
				    , max(h.memo) as memo
				    , max(h.status) as status
				    , max(h.if_status) as if_status
				    , max(h.cr_user) as cr_user
				    , max(h.cr_date) as cr_date
				    , max(h.md_user) md_user, max(h.md_date) md_date
		    	from
		    	openmps.mp_order_h h
			    inner join openmps.mp_order_d d on (
			    		h.corp_code = d.corp_code
			    		and h.delv_date = d.delv_date
			    		and h.ordr_no = d.ordr_no
			    		and h.ordr_cust = #ordrCust#
			    	)
			    where h.corp_code = #corpCode#
			    and h.delv_date = #delvDate#
			    and h.ordr_no = #ordrNo#
			    and h.ordr_cust = #ordrCust#
		    )
		    tt
	</insert>
	
	<!-- 
		
		전표유형 회송의 매출전표생성.
	
	  -->
	<insert id="SD0803MpOrderDDAO.insertReturnReCreateMpOrderD">
		<selectKey keyProperty="ordrCust" resultClass="string">
		    select #ordrCust# as ordr_cust
		</selectKey>
			insert into openmps.mp_order_d
			select 
				corp_code
				, delv_date
				, ordr_no
				, ordr_seq, pro_code, sale_group2
				, pro_ukind, price_src
			    , cur_price as unit_price
			    , ordr_box
			    , ordr_weight
			    , (ordr_box * cur_price) as ordr_amt
			    , ordr_vat
			    , delv_box, delv_weight, delv_amt, delv_vat, weight_comp
			    , pm_accept_yn, status, if_status, cust_po_no, cust_po_seq, cust_pro_code
			    , cr_user, cr_date, md_user, md_date
			from
			( 
				select
				corp_code, #newDelvDate# as delv_date, #newOrdrNo# ordr_no, ordr_seq, pro_code, sale_group2, 
			       pro_ukind, price_src
			       , unit_price
			       , ordr_box
			       , coalesce(ordr_weight,0) * -1 as ordr_weight
			       , coalesce(ordr_amt,0) * -1 as ordr_amt
			       , coalesce(ordr_vat,0) as ordr_vat
			       , delv_box, delv_weight, delv_amt, delv_vat, weight_comp, 
			       pm_accept_yn, status, if_status, cust_po_no, cust_po_seq, cust_pro_code, 
			       cr_user, cr_date, md_user, md_date
			       ,openmps."FN_GET_PROPRICE"(corp_code, #newDelvDate#, #ordrCust#, pro_code) cur_price
				from openmps.mp_order_d
				where corp_code = #corpCode#
			    and delv_date = #delvDate#
			    and ordr_no = #ordrNo#
			)
			tt
	</insert>
	
	<select id="SD0803MpOrderDDAO.selectMpOrderDList_D" parameterClass="SD0803MpOrderHSerarchVO" resultClass="egovMap">
	
		select
			tt.corp_code
			,tt.ordr_cust
			,tt.ordr_custname
			,tt.delv_date
			,tt.ordr_no
			,tt.ordr_type
			,tt.ordr_seq
			,tt.pro_code
			,tt.pro_name
			,tt.ordr_weight
			,tt.unit_price
			,tt.cur_price
			<![CDATA[	,(case when tt.cur_price > 0 and tt.unit_price != tt.cur_price then 'Y' else 'N' end) as price_chg_yn ]]>
			,tt.ordr_amt
			,tt.re_ordr_weight
			,tt.re_unit_price
			,tt.re_ordr_amt
			,tt.new_ordr_weight
			,tt.new_ordr_price
			,tt.new_ordr_amt
		from
		(
			select
					old.corp_code
					, old.ordr_cust
					, openmps."FN_GET_CUSTCODENM"(old.corp_code,old.ordr_cust) as ordr_custname 
					, old.delv_date
					, old.ordr_no
					, old.ordr_type
					, old.ordr_seq
					, old.pro_code
					, openmps."FN_GET_PROCODENM"(old.corp_code,old.pro_code) as pro_name
					, old.ordr_weight
					, old.unit_price
					, openmps."FN_GET_PROPRICE"(old.corp_code, old.delv_date, old.ordr_cust, old.pro_code) cur_price
					, old.ordr_amt
					
					, re.ordr_no as return_ordr_no
					, re.ordr_weight as re_ordr_weight
					, re.unit_price as re_unit_price
					, re.ordr_amt as re_ordr_amt
					
					, newc.ordr_no as new_ordr_no
					, newc.ordr_weight as new_ordr_weight
					, newc.unit_price as new_ordr_price
					, newc.ordr_amt as new_ordr_amt
			FROM 
			(
				select
				a.corp_code
				,a.ordr_cust
				,a.delv_date
				,a.ordr_no
				,a.ordr_type
				,d.ordr_seq
				,d.pro_code
				,d.ordr_weight
				,d.unit_price
				,d.ordr_amt
				from openmps.mp_order_h a
				inner join openmps.mp_order_d d on (a.corp_code = d.corp_code 
										and a.delv_date = d.delv_date 
										and a.ordr_no = d.ordr_no)
				WHERE a.corp_code=#corpCode#
					AND a.delv_date=#delvDate#
					AND a.ordr_no=#ordrNo#
			) old
			left outer join 
			(
				select
				a.corp_code
				,a.ordr_cust
				,a.delv_date
				,a.ordr_no
				,d.ordr_seq
				,d.pro_code
				,d.ordr_weight
				,d.unit_price
				,d.ordr_amt
				from openmps.mp_order_h a
				inner join openmps.mp_order_d d on (a.corp_code = d.corp_code 
										and a.delv_date = d.delv_date 
										and a.ordr_no = d.ordr_no)
				WHERE a.corp_code=#corpCode#
					AND a.delv_date=#returnDelvDate#
					AND a.ordr_no=#returnOrdrNo#
			) re
			on
			(
				old.corp_code = re.corp_code
				and old.delv_date = re.corp_code
				and old.pro_code = re.pro_code
				and old.ordr_seq = re.ordr_seq
			)
			left outer join 
			(
				select
				a.corp_code
				,a.ordr_cust
				,a.delv_date
				,a.ordr_no
				,d.ordr_seq
				,d.pro_code
				,d.ordr_weight
				,d.unit_price
				,d.ordr_amt
				from openmps.mp_order_h a
				inner join openmps.mp_order_d d on (a.corp_code = d.corp_code 
										and a.delv_date = d.delv_date 
										and a.ordr_no = d.ordr_no)
				WHERE a.corp_code=#corpCode#
					AND a.delv_date=#newDelvDate#
					AND a.ordr_no=#newOrdrNo#
			) newc
			on
			(
				old.corp_code = newc.corp_code
				and old.delv_date = newc.corp_code
				and old.pro_code = newc.pro_code
				and old.ordr_seq = newc.ordr_seq
			)
		) tt
	</select>	
	<select id="SD0803MpOrderDDAO.selectMpOrderDListTotCnt_S" parameterClass="SD0803MpOrderHSerarchVO" resultClass="int">
	</select>

</sqlMap>
